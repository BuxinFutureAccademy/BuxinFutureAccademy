{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-boxes me-2"></i>Manage Products</h2>
                    <p class="text-muted mb-0">Manage your store's product catalog</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('export_products') }}" class="btn btn-outline-primary">
                        <i class="fas fa-download me-2"></i>Export CSV
                    </a>
                    <a href="{{ url_for('create_product') }}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Add New Product
                    </a>
                </div>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                            <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' or category == 'danger' else 'check-circle' if category == 'success' else 'info-circle' }} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Product Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Products</h6>
                                    <h3>{{ products|length }}</h3>
                                </div>
                                <i class="fas fa-boxes fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Active Products</h6>
                                    <h3>{{ products|selectattr('is_active')|list|length }}</h3>
                                </div>
                                <i class="fas fa-check-circle fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Low Stock</h6>
                                    <h3>{{ products|selectattr('stock_quantity', 'lt', 10)|selectattr('product_type', 'equalto', 'Physical')|list|length }}</h3>
                                </div>
                                <i class="fas fa-exclamation-triangle fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Digital Products</h6>
                                    <h3>{{ products|selectattr('product_type', 'equalto', 'Digital')|list|length }}</h3>
                                </div>
                                <i class="fas fa-download fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" name="search" placeholder="Search products..." value="{{ request.args.get('search', '') }}">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" name="category">
                                <option value="">All Categories</option>
                                {% for category in products|map(attribute='category')|unique %}
                                    <option value="{{ category }}" {% if request.args.get('category') == category %}selected{% endif %}>
                                        {{ category }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" name="status">
                                <option value="">All Status</option>
                                <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>Active</option>
                                <option value="inactive" {% if request.args.get('status') == 'inactive' %}selected{% endif %}>Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-outline-primary">
                                    <i class="fas fa-search"></i> Filter
                                </button>
                                <a href="{{ url_for('admin_products') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Products Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="80">Image</th>
                                    <th>Product Details</th>
                                    <th width="120">Price</th>
                                    <th width="100">Stock</th>
                                    <th width="100">Type</th>
                                    <th width="100">Status</th>
                                    <th width="150">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                <tr id="product-{{ product.id }}" {% if not product.is_active %}class="table-secondary"{% endif %}>
                                    <td>
                                        {% if product.image_url %}
                                            <img src="{{ product.image_url }}" alt="{{ product.name }}" 
                                                 class="img-thumbnail" style="height: 50px; width: 50px; object-fit: cover;"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                            <div style="display:none;" class="text-center">
                                                <i class="fas fa-image text-muted"></i>
                                            </div>
                                        {% else %}
                                            <div class="text-center">
                                                <i class="fas fa-box-open fa-2x text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div>
                                            <h6 class="mb-1">{{ product.name }}</h6>
                                            <small class="text-muted">
                                                {% if product.category %}
                                                    <span class="badge bg-light text-dark">{{ product.category }}</span>
                                                {% endif %}
                                                {% if product.brand %}
                                                    <span class="badge bg-secondary">{{ product.brand }}</span>
                                                {% endif %}
                                                {% if product.sku %}
                                                    <span class="badge bg-info">{{ product.sku }}</span>
                                                {% endif %}
                                            </small>
                                            {% if product.short_description %}
                                                <p class="mb-0 small text-muted">{{ product.short_description[:50] }}{% if product.short_description|length > 50 %}...{% endif %}</p>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <strong>
                                            {% if product.price == 0 %}
                                                <span class="text-success">FREE</span>
                                            {% else %}
                                                ${{ "%.2f"|format(product.price) }}
                                            {% endif %}
                                        </strong>
                                    </td>
                                    <td>
                                        {% if product.product_type == 'Digital' %}
                                            <span class="badge bg-info">Digital</span>
                                        {% elif product.stock_quantity == 0 %}
                                            <span class="badge bg-danger">Out of Stock</span>
                                        {% elif product.stock_quantity < 10 %}
                                            <span class="badge bg-warning text-dark">{{ product.stock_quantity or 0 }}</span>
                                        {% else %}
                                            <span class="badge bg-success">{{ product.stock_quantity or 0 }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {% if product.product_type == 'Digital' %}bg-primary{% else %}bg-secondary{% endif %}">
                                            {{ product.product_type or 'Physical' }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="status-{{ product.id }}" 
                                                   {% if product.is_active %}checked{% endif %}
                                                   onchange="toggleProductStatus({{ product.id }}, this.checked)">
                                            <label class="form-check-label small" for="status-{{ product.id }}">
                                                <span class="badge bg-{% if product.is_active %}success{% else %}secondary{% endif %}" 
                                                      id="status-badge-{{ product.id }}">
                                                    {% if product.is_active %}Active{% else %}Inactive{% endif %}
                                                </span>
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <!-- View Button -->
                                            <button class="btn btn-sm btn-outline-info" onclick="viewProduct({{ product.id }})" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            
                                            <!-- Edit Button -->
                                                 <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            
                                            <!-- Delete Button -->
                                            <button class="btn btn-sm btn-danger" 
                                                    onclick="confirmDelete({{ product.id }}, '{{ product.name|replace("'", "\\'") }}')" 
                                                    title="Delete Product">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fas fa-box-open fa-3x mb-3"></i>
                                        <h5>No products found</h5>
                                        <p>Create your first product to get started!</p>
                                        <a href="{{ url_for('create_product') }}" class="btn btn-primary">
                                            <i class="fas fa-plus me-2"></i>Add New Product
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Details Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productModalBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading product details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for delete operations -->
<form id="deleteForm" method="POST" style="display: none;">
</form>

<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('Admin Products page loaded');
    
    // Initialize tooltips if using Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Toggle product status via AJAX
function toggleProductStatus(productId, isActive) {
    console.log(`Toggling product ${productId} to ${isActive ? 'active' : 'inactive'}`);
    
    // Check if the route exists
    const toggleUrl = `/admin/toggle-product-status/${productId}`;
    
    fetch(toggleUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ is_active: isActive })
    })
    .then(response => {
        console.log('Toggle response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Toggle response data:', data);
        if (data.success) {
            const badge = document.getElementById(`status-badge-${productId}`);
            const row = document.getElementById(`product-${productId}`);
            
            if (isActive) {
                badge.textContent = 'Active';
                badge.className = 'badge bg-success';
                row.classList.remove('table-secondary');
            } else {
                badge.textContent = 'Inactive';
                badge.className = 'badge bg-secondary';
                row.classList.add('table-secondary');
            }
            
            showAlert('Product status updated successfully!', 'success');
        } else {
            showAlert(data.error || 'Failed to update product status', 'danger');
            // Revert checkbox
            document.getElementById(`status-${productId}`).checked = !isActive;
        }
    })
    .catch(error => {
        console.error('Error toggling product status:', error);
        showAlert('Error updating product status: ' + error.message, 'danger');
        // Revert checkbox
        document.getElementById(`status-${productId}`).checked = !isActive;
    });
}

// View product details
function viewProduct(productId) {
    console.log(`Viewing product ${productId}`);
    
    // Show modal immediately with loading state
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
    
    // Reset modal body to loading state
    const modalBody = document.getElementById('productModalBody');
    modalBody.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading product details...</p>
        </div>
    `;
    
    const detailsUrl = `/admin/product/${productId}/details`;
    
    fetch(detailsUrl)
    .then(response => {
        console.log('Product details response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(product => {
        console.log('Product details:', product);
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    ${product.image_url ? 
                        `<img src="${product.image_url}" class="img-fluid rounded" alt="${product.name}" 
                         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';">` :
                        '<div class="text-center p-4 bg-light rounded"><i class="fas fa-box-open fa-4x text-muted"></i><p class="mt-2 text-muted">No Image</p></div>'
                    }
                </div>
                <div class="col-md-8">
                    <h4>${product.name}</h4>
                    <p class="text-muted">${product.short_description || 'No short description'}</p>
                    <hr>
                    <p>${product.description || 'No description available'}</p>
                    
                    <div class="row mt-3">
                        <div class="col-6">
                            <strong>Price:</strong> ${product.price == 0 ? 'FREE' : '$' + product.price.toFixed(2)}<br>
                            <strong>Category:</strong> ${product.category || 'N/A'}<br>
                            <strong>Type:</strong> ${product.product_type || 'Physical'}<br>
                            <strong>Created:</strong> ${new Date(product.created_at || Date.now()).toLocaleDateString()}
                        </div>
                        <div class="col-6">
                            <strong>Stock:</strong> ${product.product_type === 'Digital' ? 'Unlimited' : (product.stock_quantity || 0)}<br>
                            <strong>Brand:</strong> ${product.brand || 'N/A'}<br>
                            <strong>SKU:</strong> ${product.sku || 'N/A'}<br>
                            <strong>Sales:</strong> ${product.sales_count || 0}
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <span class="badge ${product.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${product.is_active ? 'Active' : 'Inactive'}
                        </span>
                        ${product.featured ? '<span class="badge bg-warning text-dark ms-2">Featured</span>' : ''}
                    </div>
                </div>
            </div>
        `;
    })
    .catch(error => {
        console.error('Error loading product details:', error);
        modalBody.innerHTML = `
            <div class="text-center text-danger">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h5>Error Loading Product</h5>
                <p>Unable to load product details. Please try again.</p>
                <p class="small text-muted">Error: ${error.message}</p>
            </div>
        `;
    });
}

// Confirm delete
function confirmDelete(productId, productName) {
    console.log(`Attempting to delete product ${productId}: ${productName}`);
    
    // Escape the product name for safe display
    const safeName = productName.replace(/'/g, "\\'").replace(/"/g, '\\"');
    
    const confirmed = confirm(`Are you sure you want to delete "${productName}"?\n\nThis action cannot be undone and will permanently remove the product from your store.`);
    
    if (confirmed) {
        console.log('Delete confirmed');
        
        // Show loading state
        const deleteBtn = document.querySelector(`button[onclick*="confirmDelete(${productId}"]`);
        if (deleteBtn) {
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
        
        const form = document.getElementById('deleteForm');
        form.action = `/admin/delete_product/${productId}`;
        form.submit();
    } else {
        console.log('Delete cancelled');
    }
}

// Show alert messages
function showAlert(message, type = 'info') {
    console.log(`Showing alert: ${type} - ${message}`);
    
    // Remove existing alerts
    document.querySelectorAll('.alert.position-fixed').forEach(alert => {
        alert.remove();
    });
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px;';
    
    const iconClass = type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle';
    
    alertDiv.innerHTML = `
        <i class="fas fa-${iconClass} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Error handling for images
document.addEventListener('DOMContentLoaded', function() {
    // Handle broken images
    document.querySelectorAll('img').forEach(img => {
        img.addEventListener('error', function() {
            this.style.display = 'none';
            const placeholder = this.nextElementSibling;
            if (placeholder) {
                placeholder.style.display = 'block';
            }
        });
    });
});

// Search and filter functionality
document.querySelector('form[method="GET"]').addEventListener('submit', function(e) {
    console.log('Applying filters...');
    // Form will submit normally, no need to prevent default
});

// Quick search functionality (optional)
let searchTimeout;
document.querySelector('input[name="search"]').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        // Auto-submit form after 1 second of no typing
        // this.form.submit();
    }, 1000);
});
</script>

<style>
.table-responsive {
    border-radius: 0.375rem;
}

.img-thumbnail {
    border: 2px solid #dee2e6;
    transition: transform 0.2s;
}

.img-thumbnail:hover {
    transform: scale(1.1);
}

.form-switch {
    padding-left: 2.5em;
}

.btn-group-sm > .btn, .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    transition: all 0.2s;
}

.btn-sm:hover {
    transform: translateY(-1px);
}

.badge {
    font-size: 0.75rem;
}

.opacity-50 {
    opacity: 0.5;
}

/* Hover effects */
.table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

/* Loading animation */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.fa-spin {
    animation: spin 1s linear infinite;
}

/* Alert positioning */
.alert.position-fixed {
    z-index: 9999;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

/* Modal improvements */
.modal-content {
    border: none;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

/* Responsive improvements */
@media (max-width: 768px) {
    .d-flex.gap-1 {
        flex-direction: column;
        gap: 0.25rem !important;
    }
    
    .btn-sm {
        font-size: 0.75rem;
        padding: 0.125rem 0.25rem;
    }
}
</style>
{% endblock %}
