{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Course Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="card-title mb-2">{{ course.title }}</h3>
                            <p class="card-text">{{ course.short_description or course.description[:100] + '...' }}</p>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-light text-dark me-2">{{ course.category }}</span>
                                <span class="badge bg-success me-2">{{ course.level }}</span>
                                {% if videos and videos|length > 0 %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-play me-1"></i>{{ videos|length }} lessons
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{{ url_for('my_courses') }}" class="btn btn-light">
                                <i class="fas fa-arrow-left me-2"></i>Back to My Courses
                            </a>
                            {% if current_user.is_admin %}
                                <a href="{{ url_for('debug_course_videos', course_id=course.id) }}" class="btn btn-warning" target="_blank">
                                    <i class="fas fa-bug me-2"></i>Debug
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Course Content -->
        <div class="col-md-8">
            {% if videos and videos|length > 0 %}
                <!-- Video Player Section -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-play text-primary me-2"></i>
                            <span id="currentVideoTitle">{{ videos[0].title }}</span>
                        </h5>
                        <div>
                            <span class="badge bg-secondary" id="videoCounter">1 of {{ videos|length }}</span>
                            {% if current_user.is_admin and videos[0].source_type %}
                                <span class="badge bg-info ms-2">{{ videos[0].source_type }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="video-container">
                            {% if videos[0].playback_url %}
                                <video id="courseVideo" class="w-100" controls style="max-height: 500px; background: #000;">
                                    <source src="{{ videos[0].playback_url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            {% else %}
                                <div class="alert alert-warning m-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Video Not Available:</strong> {{ videos[0].title }}
                                    {% if current_user.is_admin %}
                                        <br><small>Admin: No valid video source found. Check the debug panel.</small>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <button class="btn btn-outline-secondary" id="prevBtn" disabled>
                                <i class="fas fa-chevron-left me-2"></i>Previous
                            </button>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary" id="playPauseBtn">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-outline-secondary" id="fullscreenBtn">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                            <button class="btn btn-primary" id="nextBtn">
                                Next<i class="fas fa-chevron-right ms-2"></i>
                            </button>
                        </div>
                        <div class="mt-3">
                            <p class="text-muted mb-0" id="currentVideoDescription">{{ videos[0].description or "No description available." }}</p>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- No Videos Message -->
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <i class="fas fa-book fa-4x text-muted mb-3"></i>
                        <h4>Text-Based Course</h4>
                        <p class="text-muted">This course consists of reading materials and downloadable resources.</p>
                    </div>
                </div>
            {% endif %}

            <!-- Course Description -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-info me-2"></i>About This Course
                    </h5>
                </div>
                <div class="card-body">
                    <p>{{ course.description }}</p>
                    
                    {% if materials and materials|length > 0 %}
                        <h6 class="mt-4 mb-3">
                            <i class="fas fa-download text-warning me-2"></i>Course Materials
                        </h6>
                        <div class="row">
                            {% for material in materials %}
                                <div class="col-md-6 mb-2">
                                    <a href="{{ url_for('course_material', filename=material.filename) }}" 
                                       class="btn btn-outline-primary btn-sm w-100" target="_blank">
                                        <i class="fas fa-file-{{ material.file_type }} me-2"></i>{{ material.title }}
                                        <small class="text-muted">({{ material.get_file_size_mb() }} MB)</small>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No additional materials available for this course.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Progress Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line text-success me-2"></i>Your Progress
                    </h6>
                </div>
                <div class="card-body text-center">
                    <div class="progress-circle mb-3">
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%" 
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="overallProgress"></div>
                        </div>
                    </div>
                    <h4 class="text-success" id="progressPercentage">0%</h4>
                    <p class="text-muted">Course Completed</p>
                    {% if videos and videos|length > 0 %}
                        <small class="text-muted">
                            <span id="completedLessons">0</span> of {{ videos|length }} lessons completed
                        </small>
                    {% else %}
                        <small class="text-muted">
                            Text-based course - read materials below
                        </small>
                    {% endif %}
                </div>
            </div>

            <!-- Course Curriculum -->
            {% if videos and videos|length > 0 %}
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-list text-primary me-2"></i>Course Curriculum
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            {% for video in videos %}
                                <a href="#" class="list-group-item list-group-item-action video-item 
                                   {% if not video.playback_url %}list-group-item-secondary{% endif %}" 
                                   data-video-index="{{ loop.index0 }}"
                                   data-video-src="{{ video.playback_url or '' }}"
                                   data-video-title="{{ video.title }}"
                                   data-video-description="{{ video.description or 'No description available.' }}"
                                   data-source-type="{{ video.source_type or 'unknown' }}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <span class="lesson-number">{{ loop.index }}.</span>
                                                {{ video.title }}
                                                {% if not video.playback_url %}
                                                    <i class="fas fa-exclamation-triangle text-warning ms-2" title="Video not available"></i>
                                                {% endif %}
                                            </h6>
                                            {% if video.duration %}
                                                <small class="text-muted">
                                                    <i class="fas fa-clock me-1"></i>{{ video.duration }}
                                                </small>
                                            {% endif %}
                                            {% if current_user.is_admin %}
                                                <br><small class="text-muted">
                                                    Source: {{ video.source_type or 'unknown' }}
                                                    {% if video.source_type == 'local' and video.get('file_exists') == False %}
                                                        <span class="text-danger">(file missing)</span>
                                                    {% endif %}
                                                </small>
                                            {% endif %}
                                        </div>
                                        <div class="lesson-status">
                                            {% if video.playback_url %}
                                                <i class="fas fa-play text-muted"></i>
                                            {% else %}
                                                <i class="fas fa-times text-danger"></i>
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-book fa-3x text-muted mb-3"></i>
                        <h6>Reading Materials</h6>
                        <p class="text-muted">This course consists of reading materials and downloadable resources.</p>
                        {% if materials and materials|length > 0 %}
                            <p class="text-success">{{ materials|length }} materials available for download</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Debug Info (Admin Only) -->
{% if current_user.is_admin and debug_info %}
<div class="container-fluid mt-4">
    <div class="card bg-light">
        <div class="card-header">
            <h6 class="mb-0">üîß Debug Info (Admin Only)</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <strong>Course ID:</strong> {{ course.id }}<br>
                    <strong>Total Videos:</strong> {{ debug_info.total_videos }}<br>
                    <strong>Total Materials:</strong> {{ materials|length if materials else 0 }}
                </div>
                <div class="col-md-6">
                    <strong>Video Sources:</strong><br>
                    <ul class="small mb-0">
                        <li>Cloudinary: {{ debug_info.cloudinary_videos }}</li>
                        <li>Local: {{ debug_info.local_videos }}</li>
                        <li>Missing: {{ debug_info.missing_videos }}</li>
                        {% if debug_info.videos_with_missing_files > 0 %}
                            <li class="text-danger">Missing files: {{ debug_info.videos_with_missing_files }}</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            <div class="mt-3">
                <a href="{{ url_for('debug_course_videos', course_id=course.id) }}" class="btn btn-sm btn-warning" target="_blank">
                    <i class="fas fa-bug me-1"></i>Detailed Debug
                </a>
                <a href="{{ url_for('migrate_existing_videos') }}" class="btn btn-sm btn-info">
                    <i class="fas fa-cloud-upload-alt me-1"></i>Check Migration
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.video-container {
    position: relative;
    background: #000;
}

.list-group-item.active {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.list-group-item:hover:not(.list-group-item-secondary) {
    background-color: #f8f9fa;
}

.list-group-item-secondary {
    opacity: 0.6;
    cursor: not-allowed;
}

.lesson-status .fa-check {
    color: #198754;
}

.lesson-status .fa-play {
    color: #0d6efd;
}

.lesson-status .fa-times {
    color: #dc3545;
}

.progress-circle {
    width: 100px;
    height: 100px;
    margin: 0 auto;
}

.video-item.completed .lesson-status .fa-play {
    display: none;
}

.video-item.completed .lesson-status .fa-check {
    display: inline;
}

.video-item.current {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

/* Video loading indicator */
.video-container::before {
    content: "Loading video...";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 16px;
    z-index: 1;
    display: none;
}

.video-container.loading::before {
    display: block;
}

/* Video unavailable styling */
.video-item.unavailable {
    background-color: #f8f9fa;
    border-left: 4px solid #ffc107;
}

.video-item.unavailable .lesson-status .fa-times {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
</style>

<script>
// Enhanced JavaScript for learn_course.html template
// Replace the existing script section in your learn_course.html template with this:

document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('courseVideo');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const videoItems = document.querySelectorAll('.video-item');
    const currentVideoTitle = document.getElementById('currentVideoTitle');
    const currentVideoDescription = document.getElementById('currentVideoDescription');
    const videoCounter = document.getElementById('videoCounter');
    const videoContainer = document.querySelector('.video-container');
    
    let currentVideoIndex = 0;
    const totalVideos = {{ videos|length if videos else 0 }};
    const videosData = {{ videos|tojson if videos else '[]' }};
    
    console.log('üé¨ Enhanced video player initialization:');
    console.log('Total videos:', totalVideos);
    console.log('Videos data:', videosData);
    
    // Filter available videos
    const availableVideos = videosData.filter(video => video.playback_url && video.available);
    console.log('Available videos:', availableVideos.length);
    
    // Only initialize video functionality if videos exist
    if (totalVideos > 0 && video && availableVideos.length > 0) {
        console.log(`Initializing video player with ${availableVideos.length} available videos`);
        
        // Find first available video
        let firstAvailableIndex = 0;
        for (let i = 0; i < videosData.length; i++) {
            if (videosData[i].playback_url && videosData[i].available) {
                firstAvailableIndex = i;
                break;
            }
        }
        
        // Initialize with first available video
        currentVideoIndex = firstAvailableIndex;
        if (videoItems.length > 0) {
            videoItems[currentVideoIndex].classList.add('current');
        }
        
        // Enhanced video loading with better error handling
        video.addEventListener('loadstart', function() {
            videoContainer.classList.add('loading');
            console.log('Video loading started:', videosData[currentVideoIndex].title);
        });
        
        video.addEventListener('loadeddata', function() {
            videoContainer.classList.remove('loading');
            console.log('Video loaded successfully:', videosData[currentVideoIndex].title);
        });
        
        video.addEventListener('error', function(e) {
            videoContainer.classList.remove('loading');
            const currentVideo = videosData[currentVideoIndex];
            console.error('Video error:', e);
            console.error('Video source:', video.currentSrc);
            console.error('Video data:', currentVideo);
            
            // Show enhanced error message
            const errorMsg = document.createElement('div');
            errorMsg.className = 'alert alert-danger mt-3';
            errorMsg.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Video Error:</strong> Unable to load "${currentVideo?.title || 'Unknown Video'}"
                <br><small>Source: ${currentVideo?.source_type || 'unknown'}</small>
                <div class="mt-2">
                    <button onclick="retryVideo()" class="btn btn-sm btn-outline-primary">üîÑ Retry</button>
                    <button onclick="skipVideo()" class="btn btn-sm btn-outline-warning">‚è≠Ô∏è Skip Video</button>
                    {% if current_user.is_admin %}
                        <a href="/admin/debug-course-videos/{{ course.id }}" target="_blank" class="btn btn-sm btn-outline-info">üîß Debug</a>
                    {% endif %}
                </div>
            `;
            
            // Remove any existing error messages
            const existingErrors = video.parentNode.querySelectorAll('.alert-danger');
            existingErrors.forEach(err => err.remove());
            
            video.parentNode.appendChild(errorMsg);
        });
        
        // Play/Pause functionality
        if (playPauseBtn) {
            playPauseBtn.addEventListener('click', function() {
                if (video.paused) {
                    video.play().catch(e => {
                        console.error('Play error:', e);
                        showNotification('Unable to play video. Please check your internet connection.', 'danger');
                    });
                } else {
                    video.pause();
                }
            });
        }
        
        // Fullscreen functionality
        if (fullscreenBtn) {
            fullscreenBtn.addEventListener('click', function() {
                if (video.requestFullscreen) {
                    video.requestFullscreen();
                } else if (video.webkitRequestFullscreen) {
                    video.webkitRequestFullscreen();
                } else if (video.msRequestFullscreen) {
                    video.msRequestFullscreen();
                }
            });
        }
        
        // Video ended event
        video.addEventListener('ended', function() {
            markVideoAsCompleted(currentVideoIndex);
            if (hasNextAvailableVideo()) {
                setTimeout(() => {
                    nextVideo();
                }, 1000);
            }
        });
        
        // Video play/pause events
        video.addEventListener('play', function() {
            if (playPauseBtn) playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        });
        
        video.addEventListener('pause', function() {
            if (playPauseBtn) playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        });
        
        // Navigation buttons
        if (prevBtn) prevBtn.addEventListener('click', prevVideo);
        if (nextBtn) nextBtn.addEventListener('click', nextVideo);
        
        // Curriculum item clicks
        videoItems.forEach((item, index) => {
            const videoData = videosData[index];
            if (videoData && videoData.playback_url && videoData.available) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    loadVideo(index);
                });
                item.style.cursor = 'pointer';
            } else {
                item.classList.add('unavailable');
                item.style.cursor = 'not-allowed';
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    showNotification(`Video "${videoData?.title || 'Unknown'}" is not available`, 'warning');
                });
            }
        });
        
        function loadVideo(index) {
            if (index < 0 || index >= totalVideos) return;
            
            const videoData = videosData[index];
            if (!videoData || !videoData.playback_url || !videoData.available) {
                console.warn(`Video at index ${index} is not available`);
                showNotification(`Video "${videoData?.title || 'Unknown'}" is not available`, 'warning');
                return;
            }
            
            console.log(`Loading video ${index + 1}/${totalVideos}: ${videoData.title}`);
            console.log(`Source: ${videoData.source_type}, URL: ${videoData.playback_url}`);
            currentVideoIndex = index;
            
            // Show loading state
            videoContainer.classList.add('loading');
            
            // Clear any existing error messages
            const existingErrors = video.parentNode.querySelectorAll('.alert-danger');
            existingErrors.forEach(err => err.remove());
            
            // Update video source
            video.src = videoData.playback_url;
            video.load();
            
            // Update UI
            if (currentVideoTitle) currentVideoTitle.textContent = videoData.title;
            if (currentVideoDescription) currentVideoDescription.textContent = videoData.description || 'No description available.';
            if (videoCounter) videoCounter.textContent = `${index + 1} of ${totalVideos}`;
            
            // Update curriculum highlighting
            videoItems.forEach(item => item.classList.remove('current'));
            if (videoItems[index]) videoItems[index].classList.add('current');
            
            // Update navigation buttons
            updateNavigationButtons();
        }
        
        function updateNavigationButtons() {
            if (prevBtn) prevBtn.disabled = !hasPreviousAvailableVideo();
            if (nextBtn) {
                nextBtn.disabled = !hasNextAvailableVideo();
                if (!hasNextAvailableVideo() && isLastVideo()) {
                    nextBtn.innerHTML = 'Course Complete!<i class="fas fa-check ms-2"></i>';
                } else {
                    nextBtn.innerHTML = 'Next<i class="fas fa-chevron-right ms-2"></i>';
                }
            }
        }
        
        function nextVideo() {
            for (let i = currentVideoIndex + 1; i < totalVideos; i++) {
                if (videosData[i] && videosData[i].playback_url && videosData[i].available) {
                    loadVideo(i);
                    return;
                }
            }
            console.log('No more available videos');
            showNotification('You have completed all available videos!', 'success');
        }
        
        function prevVideo() {
            for (let i = currentVideoIndex - 1; i >= 0; i--) {
                if (videosData[i] && videosData[i].playback_url && videosData[i].available) {
                    loadVideo(i);
                    return;
                }
            }
            console.log('No previous available videos');
        }
        
        function hasNextAvailableVideo() {
            for (let i = currentVideoIndex + 1; i < totalVideos; i++) {
                if (videosData[i] && videosData[i].playback_url && videosData[i].available) {
                    return true;
                }
            }
            return false;
        }
        
        function hasPreviousAvailableVideo() {
            for (let i = currentVideoIndex - 1; i >= 0; i--) {
                if (videosData[i] && videosData[i].playback_url && videosData[i].available) {
                    return true;
                }
            }
            return false;
        }
        
        function isLastVideo() {
            return currentVideoIndex === totalVideos - 1;
        }
        
        function markVideoAsCompleted(index) {
            const videoItem = videoItems[index];
            if (videoItem) {
                videoItem.classList.add('completed');
                const statusIcon = videoItem.querySelector('.lesson-status i');
                if (statusIcon) {
                    statusIcon.className = 'fas fa-check';
                }
            }
            updateProgress();
        }
        
        function updateProgress() {
            const completedVideos = document.querySelectorAll('.video-item.completed').length;
            const availableVideosCount = availableVideos.length;
            const percentage = availableVideosCount > 0 ? Math.round((completedVideos / availableVideosCount) * 100) : 0;
            
            const progressBar = document.getElementById('overallProgress');
            const progressPercentage = document.getElementById('progressPercentage');
            const completedLessons = document.getElementById('completedLessons');
            
            if (progressBar) progressBar.style.width = percentage + '%';
            if (progressPercentage) progressPercentage.textContent = percentage + '%';
            if (completedLessons) completedLessons.textContent = completedVideos;
        }
        
        // Global retry function
        window.retryVideo = function() {
            console.log('Retrying current video...');
            loadVideo(currentVideoIndex);
        };
        
        // Global skip function
        window.skipVideo = function() {
            console.log('Skipping current video...');
            if (hasNextAvailableVideo()) {
                nextVideo();
            } else {
                showNotification('No more videos to skip to.', 'info');
            }
        };
        
        // Save/load progress
        function saveProgress() {
            const courseId = {{ course.id }};
            const completedVideos = Array.from(document.querySelectorAll('.video-item.completed'))
                .map(item => parseInt(item.dataset.videoIndex));
            localStorage.setItem(`course_${courseId}_progress`, JSON.stringify({
                completedVideos: completedVideos,
                currentVideo: currentVideoIndex
            }));
        }
        
        function loadProgress() {
            const courseId = {{ course.id }};
            const saved = localStorage.getItem(`course_${courseId}_progress`);
            if (saved) {
                try {
                    const progress = JSON.parse(saved);
                    if (progress.completedVideos && Array.isArray(progress.completedVideos)) {
                        progress.completedVideos.forEach(index => {
                            if (index >= 0 && index < totalVideos) {
                                markVideoAsCompleted(index);
                            }
                        });
                    }
                    // Load last video if it's available
                    if (progress.currentVideo && progress.currentVideo >= 0 && progress.currentVideo < totalVideos) {
                        const videoData = videosData[progress.currentVideo];
                        if (videoData && videoData.playback_url && videoData.available) {
                            loadVideo(progress.currentVideo);
                            return;
                        }
                    }
                } catch (e) {
                    console.log('Error loading progress:', e);
                }
            }
            
            // Load first available video
            loadVideo(firstAvailableIndex);
        }
        
        // Auto-save progress
        video.addEventListener('timeupdate', function() {
            if (video.currentTime > 10) {
                saveProgress();
            }
        });
        
        // Initialize with saved progress
        loadProgress();
        
        console.log('‚úÖ Enhanced video player initialized successfully');
        console.log(`üìä Stats: ${availableVideos.length} available, ${totalVideos - availableVideos.length} unavailable`);
        
    } else {
        console.log('‚ÑπÔ∏è No videos available for playback');
        
        // Show appropriate message based on the situation
        if (totalVideos === 0) {
            console.log('üìö Text-based course detected');
        } else {
            console.log('‚ö†Ô∏è All videos are currently unavailable');
            showNotification('Videos are being processed. Please check back later.', 'info');
        }
    }
});

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
