{% extends "base.html" %}

{% block title %}Gallery Management - Admin{% endblock %}

{% block content %}
<style>
    .gallery-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        height: 100%;
    }
    .gallery-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .gallery-media {
        height: 180px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }
    .gallery-media img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .gallery-media .media-icon {
        font-size: 3rem;
        color: rgba(255,255,255,0.8);
    }
    .media-type-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        padding: 0.3rem 0.7rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .badge-image { background: #667eea; color: white; }
    .badge-video { background: #e74c3c; color: white; }
    .source-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 0.3rem 0.7rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    .badge-admin { background: #2ecc71; color: white; }
    .badge-project { background: #3498db; color: white; }
    .gallery-body {
        padding: 1.2rem;
    }
    .gallery-title {
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }
    .gallery-desc {
        color: #718096;
        font-size: 0.85rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        text-align: center;
    }
    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.5rem;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: 800;
        color: #2d3748;
    }
    .stat-label {
        color: #718096;
        font-size: 0.9rem;
    }
    .import-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    /* Drag and Drop Styles */
    .sortable-ghost {
        opacity: 0.4;
    }
    .sortable-drag {
        opacity: 0.8;
        transform: rotate(5deg);
    }
    .gallery-card.dragging {
        cursor: grabbing;
        transform: scale(1.05);
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .gallery-card.drag-handle {
        cursor: grab;
    }
    .gallery-card.drag-handle:hover {
        transform: translateY(-5px) scale(1.02);
    }
    .reorder-hint {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .reorder-hint i {
        font-size: 1.2rem;
    }
</style>

<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="fas fa-images me-2 text-primary"></i>Gallery Management</h2>
            <p class="text-muted mb-0">Manage homepage gallery images and videos</p>
        </div>
        <a href="{{ url_for('admin.admin_gallery_add') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-plus me-2"></i>Add Media
        </a>
    </div>

    <!-- Stats -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="fas fa-image"></i>
                </div>
                <div class="stat-number">{{ total_images }}</div>
                <div class="stat-label">Images</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;">
                    <i class="fas fa-video"></i>
                </div>
                <div class="stat-number">{{ total_videos }}</div>
                <div class="stat-label">Videos</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white;">
                    <i class="fas fa-project-diagram"></i>
                </div>
                <div class="stat-number">{{ from_projects }}</div>
                <div class="stat-label">From Student Projects</div>
            </div>
        </div>
    </div>

    <!-- Import from Student Projects -->
    <div class="import-section">
        <h5 class="mb-3"><i class="fas fa-download me-2"></i>Quick Import from Student Projects</h5>
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-muted mb-2">Projects with Images ({{ student_projects_with_images|length }})</h6>
                {% if student_projects_with_images %}
                <div class="d-flex flex-wrap gap-2">
                    {% for project in student_projects_with_images[:5] %}
                    <form action="{{ url_for('admin.admin_gallery_import_project') }}" method="POST" class="d-inline">
                        <input type="hidden" name="project_id" value="{{ project.id }}">
                        <input type="hidden" name="import_type" value="image">
                        <button type="submit" class="btn btn-sm btn-outline-primary" title="{{ project.title }}">
                            <i class="fas fa-image me-1"></i>{{ project.title[:20] }}{% if project.title|length > 20 %}...{% endif %}
                        </button>
                    </form>
                    {% endfor %}
                    {% if student_projects_with_images|length > 5 %}
                    <span class="btn btn-sm btn-light">+{{ student_projects_with_images|length - 5 }} more</span>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-muted mb-0">No student projects with images</p>
                {% endif %}
            </div>
            <div class="col-md-6">
                <h6 class="text-muted mb-2">Projects with Videos ({{ student_projects_with_videos|length }})</h6>
                {% if student_projects_with_videos %}
                <div class="d-flex flex-wrap gap-2">
                    {% for project in student_projects_with_videos[:5] %}
                    <form action="{{ url_for('admin.admin_gallery_import_project') }}" method="POST" class="d-inline">
                        <input type="hidden" name="project_id" value="{{ project.id }}">
                        <input type="hidden" name="import_type" value="video">
                        <button type="submit" class="btn btn-sm btn-outline-danger" title="{{ project.title }}">
                            <i class="fas fa-video me-1"></i>{{ project.title[:20] }}{% if project.title|length > 20 %}...{% endif %}
                        </button>
                    </form>
                    {% endfor %}
                    {% if student_projects_with_videos|length > 5 %}
                    <span class="btn btn-sm btn-light">+{{ student_projects_with_videos|length - 5 }} more</span>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-muted mb-0">No student projects with videos</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="d-flex gap-2 mb-4">
        <a href="{{ url_for('admin.admin_gallery') }}" class="btn {% if not media_type_filter and not source_filter %}btn-primary{% else %}btn-outline-secondary{% endif %}">
            All
        </a>
        <a href="{{ url_for('admin.admin_gallery', type='image') }}" class="btn {% if media_type_filter == 'image' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
            <i class="fas fa-image me-1"></i>Images
        </a>
        <a href="{{ url_for('admin.admin_gallery', type='video') }}" class="btn {% if media_type_filter == 'video' %}btn-danger{% else %}btn-outline-secondary{% endif %}">
            <i class="fas fa-video me-1"></i>Videos
        </a>
        <a href="{{ url_for('admin.admin_gallery', source='admin') }}" class="btn {% if source_filter == 'admin' %}btn-success{% else %}btn-outline-secondary{% endif %}">
            Admin Added
        </a>
        <a href="{{ url_for('admin.admin_gallery', source='student_project') }}" class="btn {% if source_filter == 'student_project' %}btn-info{% else %}btn-outline-secondary{% endif %}">
            From Projects
        </a>
    </div>

    <!-- Reorder Hint for Images and Videos -->
    {% if (media_type_filter == 'video' or media_type_filter == 'image' or not media_type_filter) and gallery_items %}
    <div class="reorder-hint">
        <i class="fas fa-grip-vertical"></i>
        <span><strong>Drag and drop</strong> {% if media_type_filter == 'video' %}videos{% elif media_type_filter == 'image' %}images{% else %}items{% endif %} to reorder them. The order here determines how they appear on the homepage.</span>
    </div>
    {% endif %}

    <!-- Gallery Grid -->
    {% if gallery_items %}
    <div class="row g-4" id="gallery-grid" {% if media_type_filter == 'video' or media_type_filter == 'image' or not media_type_filter %}data-sortable="true"{% endif %}>
        {% for item in gallery_items %}
        <div class="col-lg-3 col-md-4 col-6" data-item-id="{{ item.id }}" data-media-type="{{ item.media_type }}">
            <div class="gallery-card {% if media_type_filter == 'video' or media_type_filter == 'image' or not media_type_filter %}drag-handle{% endif %}">
                <div class="gallery-media">
                    {% if item.media_type == 'image' %}
                    <img src="{{ item.media_url }}" alt="{{ item.title }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="media-icon" style="display: none;"><i class="fas fa-image"></i></div>
                    {% else %}
                    {% if item.thumbnail_url %}
                    <img src="{{ item.thumbnail_url }}" alt="{{ item.title }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="media-icon" style="display: none;"><i class="fas fa-play-circle"></i></div>
                    {% else %}
                    <div class="media-icon"><i class="fas fa-play-circle"></i></div>
                    {% endif %}
                    {% endif %}
                    <span class="media-type-badge {% if item.media_type == 'image' %}badge-image{% else %}badge-video{% endif %}">
                        {{ item.media_type }}
                    </span>
                    <span class="source-badge {% if item.source_type == 'admin' %}badge-admin{% else %}badge-project{% endif %}">
                        {% if item.source_type == 'admin' %}Admin{% else %}Project{% endif %}
                    </span>
                </div>
                <div class="gallery-body">
                    <h6 class="gallery-title">{{ item.title }}</h6>
                    {% if item.description %}
                    <p class="gallery-desc">{{ item.description }}</p>
                    {% endif %}
                    <div class="d-flex gap-2 mt-3">
                        {% if item.is_featured %}
                        <span class="badge bg-warning text-dark"><i class="fas fa-star me-1"></i>Featured</span>
                        {% endif %}
                        {% if not item.is_active %}
                        <span class="badge bg-secondary">Inactive</span>
                        {% endif %}
                    </div>
                    <div class="d-flex gap-2 mt-3">
                        <a href="{{ url_for('admin.admin_gallery_edit', item_id=item.id) }}" class="btn btn-sm btn-outline-primary flex-grow-1">
                            <i class="fas fa-edit"></i>
                        </a>
                        <form action="{{ url_for('admin.admin_gallery_delete', item_id=item.id) }}" method="POST" onsubmit="return confirm('Delete this item?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-images fa-4x text-muted mb-3"></i>
        <h4>No Gallery Items Yet</h4>
        <p class="text-muted">Add images and videos to showcase on the homepage</p>
        <a href="{{ url_for('admin.admin_gallery_add') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Add First Media
        </a>
    </div>
    {% endif %}
</div>

<!-- SortableJS Library for Drag and Drop -->
{% if media_type_filter == 'video' or media_type_filter == 'image' or not media_type_filter %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const galleryGrid = document.getElementById('gallery-grid');
    if (!galleryGrid || galleryGrid.getAttribute('data-sortable') !== 'true') {
        return;
    }

    // Initialize SortableJS
    const sortable = new Sortable(galleryGrid, {
        animation: 150,
        handle: '.gallery-card',
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
        onStart: function(evt) {
            evt.item.classList.add('dragging');
        },
        onEnd: function(evt) {
            evt.item.classList.remove('dragging');
            
            // Get the new order of items
            const items = Array.from(galleryGrid.children);
            const itemIds = items.map(item => {
                return parseInt(item.getAttribute('data-item-id'));
            }).filter(id => !isNaN(id));
            
            // Get current filter type (or empty for 'all')
            const mediaType = '{{ media_type_filter }}' || '';
            
            // Send update to server
            fetch('{{ url_for("admin.admin_gallery_reorder") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    item_ids: itemIds,
                    media_type: mediaType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const hint = document.querySelector('.reorder-hint');
                    if (hint) {
                        const originalText = hint.innerHTML;
                        hint.innerHTML = '<i class="fas fa-check-circle"></i><span>Order saved successfully!</span>';
                        hint.style.background = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
                        setTimeout(() => {
                            hint.innerHTML = originalText;
                            hint.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        }, 2000);
                    }
                } else {
                    alert('Error updating order: ' + (data.error || 'Unknown error'));
                    // Reload page to restore original order
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the order. Please try again.');
                // Reload page to restore original order
                location.reload();
            });
        }
    });
});
</script>
{% endif %}
{% endblock %}

