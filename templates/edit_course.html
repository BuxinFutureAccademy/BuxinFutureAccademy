{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4><i class="fas fa-edit me-2"></i>‚úèÔ∏è Edit Course</h4>
                </div>
                <div class="card-body">
                    <form method="POST" id="editCourseForm">
                        <!-- Course Preview -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                {% if course.image_url %}
                                    <img src="{{ course.image_url }}" class="img-fluid rounded shadow-sm" 
                                         alt="{{ course.title }}" style="max-height: 200px; width: 100%; object-fit: cover;">
                                {% else %}
                                    <div class="bg-gradient rounded d-flex align-items-center justify-content-center shadow-sm" 
                                         style="height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <i class="fas fa-graduation-cap fa-3x text-white"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-8">
                                <div class="course-stats">
                                    <h5 class="text-muted mb-3">üìä Course Statistics</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="stat-card bg-primary text-white p-3 rounded mb-2">
                                                <i class="fas fa-users fa-2x mb-2"></i>
                                                <h4>{{ course.get_enrolled_count() }}</h4>
                                                <small>Enrolled Students</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="stat-card bg-success text-white p-3 rounded mb-2">
                                                <i class="fas fa-play fa-2x mb-2"></i>
                                                <h4 id="videoCount">{{ course.get_video_count() }}</h4>
                                                <small>Video Lessons</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="stat-card bg-info text-white p-3 rounded">
                                                <i class="fas fa-file fa-2x mb-2"></i>
                                                <h4 id="materialCount">{{ course.materials|length }}</h4>
                                                <small>Course Materials</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="stat-card bg-warning text-dark p-3 rounded">
                                                <i class="fas fa-clock fa-2x mb-2"></i>
                                                <h4>{{ course.get_total_duration() or 'TBD' }}</h4>
                                                <small>Total Duration</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Basic Course Information -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>üìù Basic Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <label for="title" class="form-label">Course Title *</label>
                                        <input type="text" class="form-control" id="title" name="title" 
                                               value="{{ course.title }}" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="price" class="form-label">Price (GMD) *</label>
                                        <input type="number" class="form-control" id="price" name="price" 
                                               step="0.01" min="0" value="{{ course.price }}" required>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="short_description" class="form-label">Short Description</label>
                                    <input type="text" class="form-control" id="short_description" name="short_description" 
                                           value="{{ course.short_description or '' }}" maxlength="500"
                                           placeholder="Brief description for course cards">
                                    <div class="form-text">üìè Brief summary for course listings (max 500 characters)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label">Full Description *</label>
                                    <textarea class="form-control" id="description" name="description" rows="5" 
                                              placeholder="Detailed course description" required>{{ course.description }}</textarea>
                                    <div class="form-text">üìñ Detailed course description for the course page</div>
                                </div>
                            </div>
                        </div>

                        <!-- Course Categories and Settings -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-cog me-2"></i>‚öôÔ∏è Course Settings</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="category" class="form-label">Category *</label>
                                        <select class="form-select" id="category" name="category" required>
                                            <option value="">üéØ Select Category</option>
                                            <optgroup label="ü§ñ Technology & Engineering">
                                                <option value="Artificial Intelligence" {% if course.category == 'Artificial Intelligence' %}selected{% endif %}>ü§ñ Artificial Intelligence</option>
                                                <option value="Machine Learning" {% if course.category == 'Machine Learning' %}selected{% endif %}>üß† Machine Learning</option>
                                                <option value="Electronics Engineering" {% if course.category == 'Electronics Engineering' %}selected{% endif %}>‚ö° Electronics Engineering</option>
                                                <option value="Microcontrollers" {% if course.category == 'Microcontrollers' %}selected{% endif %}>üîå Microcontrollers</option>
                                                <option value="Robotics" {% if course.category == 'Robotics' %}selected{% endif %}>ü§ñ Robotics</option>
                                                <option value="IoT Development" {% if course.category == 'IoT Development' %}selected{% endif %}>üì° IoT Development</option>
                                            </optgroup>
                                            <optgroup label="üíª Programming & Development">
                                                <option value="Programming" {% if course.category == 'Programming' %}selected{% endif %}>üíª Programming</option>
                                                <option value="Web Development" {% if course.category == 'Web Development' %}selected{% endif %}>üåê Web Development</option>
                                                <option value="Mobile Development" {% if course.category == 'Mobile Development' %}selected{% endif %}>üì± Mobile Development</option>
                                                <option value="Data Science" {% if course.category == 'Data Science' %}selected{% endif %}>üìä Data Science</option>
                                                <option value="Cybersecurity" {% if course.category == 'Cybersecurity' %}selected{% endif %}>üîí Cybersecurity</option>
                                                <option value="Cloud Computing" {% if course.category == 'Cloud Computing' %}selected{% endif %}>‚òÅÔ∏è Cloud Computing</option>
                                            </optgroup>
                                            <optgroup label="üé® Design & Creative">
                                                <option value="UI/UX Design" {% if course.category == 'UI/UX Design' %}selected{% endif %}>üé® UI/UX Design</option>
                                                <option value="Graphic Design" {% if course.category == 'Graphic Design' %}selected{% endif %}>üñºÔ∏è Graphic Design</option>
                                                <option value="3D Modeling" {% if course.category == '3D Modeling' %}selected{% endif %}>üéØ 3D Modeling</option>
                                                <option value="Photography" {% if course.category == 'Photography' %}selected{% endif %}>üì∏ Photography</option>
                                                <option value="Video Editing" {% if course.category == 'Video Editing' %}selected{% endif %}>üé¨ Video Editing</option>
                                            </optgroup>
                                            <optgroup label="üìà Business & Marketing">
                                                <option value="Digital Marketing" {% if course.category == 'Digital Marketing' %}selected{% endif %}>üìà Digital Marketing</option>
                                                <option value="Business Strategy" {% if course.category == 'Business Strategy' %}selected{% endif %}>üíº Business Strategy</option>
                                                <option value="E-commerce" {% if course.category == 'E-commerce' %}selected{% endif %}>üõí E-commerce</option>
                                                <option value="Project Management" {% if course.category == 'Project Management' %}selected{% endif %}>üìã Project Management</option>
                                                <option value="Financial Analysis" {% if course.category == 'Financial Analysis' %}selected{% endif %}>üí∞ Financial Analysis</option>
                                            </optgroup>
                                            <optgroup label="üéµ Arts & Media">
                                                <option value="Music Production" {% if course.category == 'Music Production' %}selected{% endif %}>üéµ Music Production</option>
                                                <option value="Animation" {% if course.category == 'Animation' %}selected{% endif %}>üéûÔ∏è Animation</option>
                                                <option value="Content Creation" {% if course.category == 'Content Creation' %}selected{% endif %}>üìù Content Creation</option>
                                                <option value="Digital Art" {% if course.category == 'Digital Art' %}selected{% endif %}>üé® Digital Art</option>
                                            </optgroup>
                                            <optgroup label="üèóÔ∏è Engineering & Sciences">
                                                <option value="Mechanical Engineering" {% if course.category == 'Mechanical Engineering' %}selected{% endif %}>‚öôÔ∏è Mechanical Engineering</option>
                                                <option value="Civil Engineering" {% if course.category == 'Civil Engineering' %}selected{% endif %}>üèóÔ∏è Civil Engineering</option>
                                                <option value="Mathematics" {% if course.category == 'Mathematics' %}selected{% endif %}>üî¢ Mathematics</option>
                                                <option value="Physics" {% if course.category == 'Physics' %}selected{% endif %}>‚öõÔ∏è Physics</option>
                                                <option value="Chemistry" {% if course.category == 'Chemistry' %}selected{% endif %}>üß™ Chemistry</option>
                                            </optgroup>
                                            <optgroup label="üåç Languages & Communication">
                                                <option value="English Language" {% if course.category == 'English Language' %}selected{% endif %}>üá∫üá∏ English Language</option>
                                                <option value="French Language" {% if course.category == 'French Language' %}selected{% endif %}>üá´üá∑ French Language</option>
                                                <option value="Spanish Language" {% if course.category == 'Spanish Language' %}selected{% endif %}>üá™üá∏ Spanish Language</option>
                                                <option value="Communication Skills" {% if course.category == 'Communication Skills' %}selected{% endif %}>üí¨ Communication Skills</option>
                                                <option value="Public Speaking" {% if course.category == 'Public Speaking' %}selected{% endif %}>üé§ Public Speaking</option>
                                            </optgroup>
                                            <optgroup label="üìö Academic & General">
                                                <option value="Study Skills" {% if course.category == 'Study Skills' %}selected{% endif %}>üìñ Study Skills</option>
                                                <option value="Research Methods" {% if course.category == 'Research Methods' %}selected{% endif %}>üîç Research Methods</option>
                                                <option value="Critical Thinking" {% if course.category == 'Critical Thinking' %}selected{% endif %}>üß© Critical Thinking</option>
                                                <option value="Other" {% if course.category == 'Other' %}selected{% endif %}>üì¶ Other</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="level" class="form-label">Level *</label>
                                        <select class="form-select" id="level" name="level" required>
                                            <option value="">üìö Select Level</option>
                                            <option value="Beginner" {% if course.level == 'Beginner' %}selected{% endif %}>üå± Beginner</option>
                                            <option value="Intermediate" {% if course.level == 'Intermediate' %}selected{% endif %}>üìà Intermediate</option>
                                            <option value="Advanced" {% if course.level == 'Advanced' %}selected{% endif %}>üöÄ Advanced</option>
                                            <option value="Expert" {% if course.level == 'Expert' %}selected{% endif %}>üèÜ Expert</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="duration_weeks" class="form-label">Duration (weeks)</label>
                                        <input type="number" class="form-control" id="duration_weeks" name="duration_weeks" 
                                               value="{{ course.duration_weeks }}" min="1" max="52">
                                        <div class="form-text">‚è±Ô∏è Expected completion time</div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="image_url" class="form-label">Course Image URL</label>
                                    <input type="url" class="form-control" id="image_url" name="image_url" 
                                           value="{{ course.image_url or '' }}" placeholder="https://example.com/image.jpg">
                                    <div class="form-text">üñºÔ∏è Course thumbnail image (recommended: 400x300px)</div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                                   {% if course.is_active %}checked{% endif %}>
                                            <label class="form-check-label" for="is_active">
                                                ‚úÖ Course is active (visible in store)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="featured" name="featured" 
                                                   {% if course.featured %}checked{% endif %}>
                                            <label class="form-check-label" for="featured">
                                                ‚≠ê Featured course (appears in highlights)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Video Management Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-play me-2"></i>üé¨ Video Lessons</h5>
                                <button type="button" class="btn btn-success btn-sm" onclick="showAddVideoForm()">
                                    <i class="fas fa-plus me-1"></i>üìπ Add Video
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Existing Videos List -->
                                <div id="videosList">
                                    {% if course.videos %}
                                        {% for video in course.videos %}
                                            <div class="video-item border rounded p-3 mb-3" data-video-id="{{ video.id }}">
                                                <div class="row align-items-center">
                                                    <div class="col-md-1">
                                                        <span class="badge bg-primary fs-6">{{ loop.index }}</span>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6 class="mb-1">{{ video.title }}</h6>
                                                        {% if video.description %}
                                                            <small class="text-muted">{{ video.description[:100] }}{% if video.description|length > 100 %}...{% endif %}</small>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-2">
                                                        {% if video.duration %}
                                                            <small class="text-muted">
                                                                <i class="fas fa-clock me-1"></i>{{ video.duration }}
                                                            </small>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-3 text-end">
                                                        <div class="btn-group">
                                                            {% if video.video_url %}
                                                                <a href="{{ video.video_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                                    <i class="fas fa-play me-1"></i>Play
                                                                </a>
                                                            {% else %}
                                                                <a href="{{ url_for('course_video', filename=video.video_filename) }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                                    <i class="fas fa-play me-1"></i>Play
                                                                </a>
                                                            {% endif %}
                                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="editVideo({{ video.id }})">
                                                                <i class="fas fa-edit me-1"></i>Edit
                                                            </button>
                                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteVideo({{ video.id }}, '{{ video.title|replace("'", "\\'") }}')">
                                                                <i class="fas fa-trash me-1"></i>Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center py-4" id="noVideosMessage">
                                            <i class="fas fa-video fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">No videos uploaded yet</h5>
                                            <p class="text-muted">Click "Add Video" to upload your first lesson</p>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Add Video Form (Fixed and Enhanced) -->
                                <div id="addVideoForm" class="border rounded p-4 mt-3" style="display: none; background: #f8f9fa; border: 2px dashed #007bff;">
                                    <h6 class="mb-3">üìπ Add New Video Lesson</h6>
                                    <form id="videoUploadForm" enctype="multipart/form-data">
                                        <input type="hidden" name="course_id" value="{{ course.id }}">
                                        <div class="row">
                                            <div class="col-md-8 mb-3">
                                                <label for="videoTitle" class="form-label">Lesson Title *</label>
                                                <input type="text" class="form-control" id="videoTitle" name="video_title" required>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="videoOrder" class="form-label">Order</label>
                                                <input type="number" class="form-control" id="videoOrder" name="video_order" min="1" value="{{ course.videos|length + 1 }}">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-8 mb-3">
                                                <label for="videoFile" class="form-label">Video File *</label>
                                                <input type="file" class="form-control" id="videoFile" name="video_file" 
                                                       accept=".mp4,.avi,.mov,.wmv,.flv,.webm,.mkv" required>
                                                <div class="form-text">üìã Supported: MP4, AVI, MOV, WMV, FLV, WebM, MKV (Max 500MB)</div>
                                                <div id="fileInfo" class="form-text text-info" style="display: none;"></div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="videoDuration" class="form-label">Duration (optional)</label>
                                                <input type="text" class="form-control" id="videoDuration" name="video_duration" 
                                                       placeholder="e.g., 10:30">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="videoDescription" class="form-label">Lesson Description</label>
                                            <textarea class="form-control" id="videoDescription" name="video_description" rows="3"></textarea>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-success" id="uploadVideoBtn">
                                                <i class="fas fa-upload me-1"></i>üì§ Upload Video
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="hideAddVideoForm()">
                                                <i class="fas fa-times me-1"></i>Cancel
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <!-- Upload Progress -->
                                    <div id="uploadProgress" class="mt-3" style="display: none;">
                                        <div class="progress" style="height: 25px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" style="width: 0%; line-height: 25px;" id="progressBar"></div>
                                        </div>
                                        <small class="text-muted mt-1 d-block" id="progressText">Preparing upload...</small>
                                    </div>
                                    
                                    <!-- Upload Status -->
                                    <div id="uploadStatus" class="mt-3" style="display: none;">
                                        <div class="alert" id="statusAlert" role="alert"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Course Materials Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-file me-2"></i>üìÅ Course Materials</h5>
                                <button type="button" class="btn btn-success btn-sm" onclick="showAddMaterialForm()">
                                    <i class="fas fa-plus me-1"></i>üìÑ Add Material
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="materialsList">
                                    {% if course.materials %}
                                        <div class="list-group">
                                            {% for material in course.materials %}
                                                <div class="list-group-item d-flex justify-content-between align-items-center" data-material-id="{{ material.id }}">
                                                    <div>
                                                        <strong>{{ material.title }}</strong>
                                                        <br><small class="text-muted">{{ material.file_type.upper() }} - {{ material.get_file_size_mb() }} MB</small>
                                                    </div>
                                                    <div class="btn-group">
                                                        <a href="{{ url_for('course_material', filename=material.filename) }}" 
                                                           class="btn btn-outline-primary btn-sm" target="_blank">
                                                            <i class="fas fa-download me-1"></i>Download
                                                        </a>
                                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                onclick="deleteMaterial({{ material.id }}, '{{ material.title|replace("'", "\\'") }}')">
                                                            <i class="fas fa-trash me-1"></i>Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="text-muted text-center py-3" id="noMaterialsMessage">
                                            <i class="fas fa-file fa-2x mb-2"></i>
                                            <p>No materials uploaded yet</p>
                                            <p><small>Click "Add Material" to upload course resources</small></p>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Add Material Form (Hidden by default) -->
                                <div id="addMaterialForm" class="border rounded p-4 mt-3" style="display: none; background: #f8f9fa; border: 2px dashed #28a745;">
                                    <h6 class="mb-3">üìÑ Add Course Material</h6>
                                    <form id="materialUploadForm" enctype="multipart/form-data">
                                        <input type="hidden" name="course_id" value="{{ course.id }}">
                                        <div class="row">
                                            <div class="col-md-8 mb-3">
                                                <label for="materialTitle" class="form-label">Material Title *</label>
                                                <input type="text" class="form-control" id="materialTitle" name="material_title" required>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="materialFile" class="form-label">File *</label>
                                                <input type="file" class="form-control" id="materialFile" name="material_file" 
                                                       accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.zip,.rar" required>
                                                <div class="form-text">üìã Supported: PDF, DOC, PPT, TXT, ZIP (Max 10MB)</div>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-success" id="uploadMaterialBtn">
                                                <i class="fas fa-upload me-1"></i>üì§ Upload Material
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="hideAddMaterialForm()">
                                                <i class="fas fa-times me-1"></i>Cancel
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-warning btn-lg" id="updateBtn">
                                    <i class="fas fa-save me-2"></i>üíæ Update Course
                                </button>
                                <a href="{{ url_for('admin_courses') }}" class="btn btn-secondary btn-lg">
                                    <i class="fas fa-arrow-left me-2"></i>‚¨ÖÔ∏è Back to Courses
                                </a>
                            </div>
                            <div>
                                <a href="{{ url_for('course_detail', course_id=course.id) }}" class="btn btn-outline-primary btn-lg" target="_blank">
                                    <i class="fas fa-eye me-2"></i>üëÅÔ∏è Preview Course
                                </a>
                                {% if course.get_enrolled_count() == 0 %}
                                    <button type="button" class="btn btn-outline-danger btn-lg" onclick="confirmDelete()">
                                        <i class="fas fa-trash me-2"></i>üóëÔ∏è Delete Course
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Video Modal -->
<div class="modal fade" id="deleteVideoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>üóëÔ∏è Delete Video
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the video lesson <strong id="videoToDelete"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-warning me-2"></i>
                    This action cannot be undone and will permanently remove the video from Cloudinary.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteVideo">
                    <i class="fas fa-trash me-2"></i>Yes, Delete Video
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Material Modal -->
<div class="modal fade" id="deleteMaterialModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>üóëÔ∏è Delete Material
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the material <strong id="materialToDelete"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-warning me-2"></i>
                    This action cannot be undone and will permanently remove the file.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteMaterial">
                    <i class="fas fa-trash me-2"></i>Yes, Delete Material
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Course Modal -->
{% if course.get_enrolled_count() == 0 %}
<div class="modal fade" id="deleteCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>üóëÔ∏è Delete Course
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-warning me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
                
                <p>Are you sure you want to delete the course <strong>"{{ course.title }}"</strong>?</p>
                
                <div class="course-delete-info">
                    <h6>This will permanently delete:</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-graduation-cap text-primary me-2"></i>The course itself</li>
                        <li><i class="fas fa-play text-success me-2"></i>All course videos ({{ course.get_video_count() }} videos)</li>
                        <li><i class="fas fa-file text-warning me-2"></i>All course materials ({{ course.materials|length }} files)</li>
                        <li><i class="fas fa-shopping-cart text-info me-2"></i>All pending cart items</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <form action="{{ url_for('delete_course', course_id=course.id) }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Yes, Delete Course
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.stat-card {
    text-align: center;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-card h4 {
    margin: 0;
    font-weight: bold;
}

.form-switch .form-check-input {
    width: 3rem;
    height: 1.5rem;
}

.video-item {
    transition: all 0.2s ease;
    border-left: 4px solid transparent !important;
    background: white;
}

.video-item:hover {
    border-left-color: #007bff !important;
    background-color: rgba(0, 123, 255, 0.05);
}

.card-header h5 {
    font-weight: 600;
}

.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
}

optgroup {
    font-weight: bold;
    font-size: 0.9rem;
}

optgroup option {
    font-weight: normal;
    padding-left: 1rem;
}

.course-delete-info ul li {
    padding: 2px 0;
}

.course-delete-info ul li i {
    width: 20px;
}

.bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

#addVideoForm {
    border: 2px dashed #007bff;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

#addMaterialForm {
    border: 2px dashed #28a745;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.progress {
    height: 25px;
}

.progress-bar {
    font-size: 14px;
    line-height: 25px;
}

.btn-group .btn {
    margin-right: 2px;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

.list-group-item {
    transition: all 0.2s ease;
}

.list-group-item:hover {
    background-color: rgba(0, 123, 255, 0.05);
}
</style>

<script>
// Global variables
let videoToDeleteId = null;
let materialToDeleteId = null;

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('editCourseForm');
    const updateBtn = document.getElementById('updateBtn');
    
    // Form submission handler
    form.addEventListener('submit', function(e) {
        // Validate required fields
        const title = document.getElementById('title').value.trim();
        const category = document.getElementById('category').value;
        const level = document.getElementById('level').value;
        const price = document.getElementById('price').value;
        
        if (!title || !category || !level || !price) {
            e.preventDefault();
            alert('‚ùå Please fill in all required fields (Title, Category, Level, Price)');
            return;
        }
        
        // Add loading state to submit button
        updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating Course...';
        updateBtn.disabled = true;
    });
    
    // Video upload form handler
    const videoUploadForm = document.getElementById('videoUploadForm');
    if (videoUploadForm) {
        videoUploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadVideo();
        });
    }
    
    // Material upload form handler
    const materialUploadForm = document.getElementById('materialUploadForm');
    if (materialUploadForm) {
        materialUploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadMaterial();
        });
    }
    
    // File input handlers
    setupFileInputHandlers();
});

// Enhanced Video Upload Function
async function uploadVideo() {
    const form = document.getElementById('videoUploadForm');
    const formData = new FormData(form);
    const uploadBtn = document.getElementById('uploadVideoBtn');
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const statusDiv = document.getElementById('uploadStatus');
    const statusAlert = document.getElementById('statusAlert');
    
    // Validate form
    const title = formData.get('video_title').trim();
    const file = formData.get('video_file');
    const courseId = formData.get('course_id');
    
    if (!title) {
        showUploadError('Please provide a video title');
        return;
    }
    
    if (!file || file.size === 0) {
        showUploadError('Please select a video file');
        return;
    }
    
    if (!courseId) {
        showUploadError('Course ID is missing');
        return;
    }
    
    // Check file size (500MB limit)
    const maxSize = 500 * 1024 * 1024; // 500MB
    if (file.size > maxSize) {
        showUploadError(`Video file is too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Maximum size is 500MB.`);
        return;
    }
    
    console.log('üöÄ Starting video upload:', {
        title: title,
        fileSize: `${(file.size / 1024 / 1024).toFixed(1)}MB`,
        courseId: courseId
    });
    
    try {
        // Show progress UI
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';
        uploadBtn.disabled = true;
        progressDiv.style.display = 'block';
        statusDiv.style.display = 'none';
        
        // Simulate upload progress
        let progress = 0;
        progressText.textContent = 'Uploading to Cloudinary...';
        
        const progressInterval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
            progressBar.textContent = `${Math.round(progress)}%`;
        }, 800);
        
        // Upload video
        console.log('üì§ Sending request to /admin/add_video_to_course');
        
        const response = await fetch('/admin/add_video_to_course', {
            method: 'POST',
            body: formData
        });
        
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        progressText.textContent = 'Processing...';
        
        console.log('üì° Response status:', response.status);
        
        if (response.ok) {
            const contentType = response.headers.get('content-type');
            
            if (contentType && contentType.includes('application/json')) {
                const result = await response.json();
                console.log('‚úÖ Upload result:', result);
                
                if (result.success) {
                    // Success - add video to the list
                    progressText.textContent = 'Upload complete!';
                    
                    setTimeout(() => {
                        addVideoToList(result.video);
                        updateVideoCount();
                        hideAddVideoForm();
                        showNotification('‚úÖ Video uploaded successfully!', 'success');
                    }, 1000);
                    
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } else {
                // Response is not JSON - likely an HTML error page
                const errorText = await response.text();
                console.error('‚ùå Non-JSON response:', errorText.substring(0, 200));
                throw new Error('Server returned an error page instead of JSON response');
            }
        } else {
            // HTTP error
            const errorText = await response.text();
            console.error('‚ùå HTTP error:', response.status, errorText.substring(0, 200));
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('‚ùå Upload error:', error);
        showUploadError(error.message);
    } finally {
        // Reset UI
        uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i>üì§ Upload Video';
        uploadBtn.disabled = false;
        progressDiv.style.display = 'none';
        progressBar.style.width = '0%';
        progressBar.textContent = '';
    }
}

// Material Upload Function
async function uploadMaterial() {
    const form = document.getElementById('materialUploadForm');
    const formData = new FormData(form);
    const uploadBtn = document.getElementById('uploadMaterialBtn');
    
    // Validate form
    const title = formData.get('material_title').trim();
    const file = formData.get('material_file');
    
    if (!title) {
        alert('‚ùå Please provide a material title');
        return;
    }
    
    if (!file || file.size === 0) {
        alert('‚ùå Please select a file');
        return;
    }
    
    // Check file size (10MB limit for materials)
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
        alert(`‚ùå File is too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Maximum size is 10MB.`);
        return;
    }
    
    try {
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';
        uploadBtn.disabled = true;
        
        const response = await fetch('/admin/add_material_to_course', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                addMaterialToList(result.material);
                updateMaterialCount();
                hideAddMaterialForm();
                showNotification('‚úÖ Material uploaded successfully!', 'success');
            } else {
                throw new Error(result.error || 'Upload failed');
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('‚ùå Material upload error:', error);
        alert('‚ùå Upload failed: ' + error.message);
    } finally {
        uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i>üì§ Upload Material';
        uploadBtn.disabled = false;
    }
}

// UI Helper Functions
function showUploadError(message) {
    const statusDiv = document.getElementById('uploadStatus');
    const statusAlert = document.getElementById('statusAlert');
    
    statusAlert.className = 'alert alert-danger';
    statusAlert.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Upload Failed:</strong> ${message}
    `;
    statusDiv.style.display = 'block';
    
    console.error('üö® Upload error:', message);
}

function addVideoToList(video) {
    const videosList = document.getElementById('videosList');
    const noVideosMsg = document.getElementById('noVideosMessage');
    
    // Hide "no videos" message
    if (noVideosMsg) {
        noVideosMsg.style.display = 'none';
    }
    
    // Create new video item
    const videoItem = document.createElement('div');
    videoItem.className = 'video-item border rounded p-3 mb-3';
    videoItem.setAttribute('data-video-id', video.id);
    
    const videoCount = videosList.querySelectorAll('.video-item').length + 1;
    
    const playUrl = video.video_url || `/course_video/${video.video_filename}`;
    const description = video.description || '';
    const duration = video.duration || '';
    
    videoItem.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-1">
                <span class="badge bg-primary fs-6">${videoCount}</span>
            </div>
            <div class="col-md-6">
                <h6 class="mb-1">${video.title}</h6>
                ${description ? `<small class="text-muted">${description.substring(0, 100)}${description.length > 100 ? '...' : ''}</small>` : ''}
            </div>
            <div class="col-md-2">
                ${duration ? `<small class="text-muted"><i class="fas fa-clock me-1"></i>${duration}</small>` : ''}
            </div>
            <div class="col-md-3 text-end">
                <div class="btn-group">
                    <a href="${playUrl}" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-play me-1"></i>Play
                    </a>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="editVideo(${video.id})">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteVideo(${video.id}, '${video.title.replace(/'/g, "\\'")}')">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    `;
    
    videosList.appendChild(videoItem);
    console.log('‚úÖ Video added to list:', video.title);
}

function addMaterialToList(material) {
    const materialsList = document.getElementById('materialsList');
    const noMaterialsMsg = document.getElementById('noMaterialsMessage');
    
    // Hide "no materials" message and create list group if needed
    if (noMaterialsMsg) {
        noMaterialsMsg.style.display = 'none';
    }
    
    let listGroup = materialsList.querySelector('.list-group');
    if (!listGroup) {
        listGroup = document.createElement('div');
        listGroup.className = 'list-group';
        materialsList.appendChild(listGroup);
    }
    
    // Create new material item
    const materialItem = document.createElement('div');
    materialItem.className = 'list-group-item d-flex justify-content-between align-items-center';
    materialItem.setAttribute('data-material-id', material.id);
    
    materialItem.innerHTML = `
        <div>
            <strong>${material.title}</strong>
            <br><small class="text-muted">${material.file_type.toUpperCase()} - ${material.file_size_mb} MB</small>
        </div>
        <div class="btn-group">
            <a href="/course_material/${material.filename}" 
               class="btn btn-outline-primary btn-sm" target="_blank">
                <i class="fas fa-download me-1"></i>Download
            </a>
            <button type="button" class="btn btn-outline-danger btn-sm" 
                    onclick="deleteMaterial(${material.id}, '${material.title.replace(/'/g, "\\'")}')">
                <i class="fas fa-trash me-1"></i>Delete
            </button>
        </div>
    `;
    
    listGroup.appendChild(materialItem);
    console.log('‚úÖ Material added to list:', material.title);
}

function updateVideoCount() {
    const videoCount = document.querySelectorAll('.video-item').length;
    const videoCountElement = document.getElementById('videoCount');
    if (videoCountElement) {
        videoCountElement.textContent = videoCount;
    }
    console.log('üìä Video count updated:', videoCount);
}

function updateMaterialCount() {
    const materialCount = document.querySelectorAll('[data-material-id]').length;
    const materialCountElement = document.getElementById('materialCount');
    if (materialCountElement) {
        materialCountElement.textContent = materialCount;
    }
    console.log('üìä Material count updated:', materialCount);
}

// Form Management Functions
function showAddVideoForm() {
    const addVideoForm = document.getElementById('addVideoForm');
    const videoTitleInput = document.getElementById('videoTitle');
    
    addVideoForm.style.display = 'block';
    if (videoTitleInput) {
        videoTitleInput.focus();
    }
    
    // Hide "no videos" message if present
    const noVideosMsg = document.getElementById('noVideosMessage');
    if (noVideosMsg) {
        noVideosMsg.style.display = 'none';
    }
    
    console.log('üìù Add video form opened');
}

function hideAddVideoForm() {
    const addVideoForm = document.getElementById('addVideoForm');
    const videoUploadForm = document.getElementById('videoUploadForm');
    const statusDiv = document.getElementById('uploadStatus');
    const fileInfo = document.getElementById('fileInfo');
    
    addVideoForm.style.display = 'none';
    if (videoUploadForm) {
        videoUploadForm.reset();
    }
    if (statusDiv) {
        statusDiv.style.display = 'none';
    }
    if (fileInfo) {
        fileInfo.style.display = 'none';
    }
    
    // Show "no videos" message if no videos exist
    const videosList = document.getElementById('videosList');
    const videoItems = videosList ? videosList.querySelectorAll('.video-item') : [];
    const noVideosMsg = document.getElementById('noVideosMessage');
    
    if (videoItems.length === 0 && noVideosMsg) {
        noVideosMsg.style.display = 'block';
    }
    
    console.log('‚ùå Add video form closed');
}

function showAddMaterialForm() {
    const addMaterialForm = document.getElementById('addMaterialForm');
    const materialTitleInput = document.getElementById('materialTitle');
    
    addMaterialForm.style.display = 'block';
    if (materialTitleInput) {
        materialTitleInput.focus();
    }
    
    // Hide "no materials" message if present
    const noMaterialsMsg = document.getElementById('noMaterialsMessage');
    if (noMaterialsMsg) {
        noMaterialsMsg.style.display = 'none';
    }
    
    console.log('üìù Add material form opened');
}

function hideAddMaterialForm() {
    const addMaterialForm = document.getElementById('addMaterialForm');
    const materialUploadForm = document.getElementById('materialUploadForm');
    
    addMaterialForm.style.display = 'none';
    if (materialUploadForm) {
        materialUploadForm.reset();
    }
    
    // Show "no materials" message if no materials exist
    const materialsList = document.getElementById('materialsList');
    const materialItems = materialsList ? materialsList.querySelectorAll('[data-material-id]') : [];
    const noMaterialsMsg = document.getElementById('noMaterialsMessage');
    
    if (materialItems.length === 0 && noMaterialsMsg) {
        noMaterialsMsg.style.display = 'block';
    }
    
    console.log('‚ùå Add material form closed');
}

// Delete Functions
function deleteVideo(videoId, videoTitle) {
    videoToDeleteId = videoId;
    document.getElementById('videoToDelete').textContent = videoTitle;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteVideoModal'));
    modal.show();
}

function deleteMaterial(materialId, materialTitle) {
    materialToDeleteId = materialId;
    document.getElementById('materialToDelete').textContent = materialTitle;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteMaterialModal'));
    modal.show();
}

// Delete Confirmation Handlers
document.getElementById('confirmDeleteVideo').addEventListener('click', async function() {
    if (!videoToDeleteId) return;
    
    const button = this;
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
        button.disabled = true;
        
        const response = await fetch(`/admin/delete_video/${videoToDeleteId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                // Remove video from DOM
                const videoItem = document.querySelector(`[data-video-id="${videoToDeleteId}"]`);
                if (videoItem) {
                    videoItem.remove();
                }
                
                // Update video count
                updateVideoCount();
                
                // Show "no videos" message if no videos left
                const remainingVideos = document.querySelectorAll('.video-item');
                const noVideosMsg = document.getElementById('noVideosMessage');
                if (remainingVideos.length === 0 && noVideosMsg) {
                    noVideosMsg.style.display = 'block';
                }
                
                // Update video numbers
                updateVideoNumbers();
                
                // Close modal and show success
                bootstrap.Modal.getInstance(document.getElementById('deleteVideoModal')).hide();
                showNotification('‚úÖ Video deleted successfully!', 'success');
            } else {
                throw new Error(result.error || 'Delete failed');
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('Delete error:', error);
        showNotification('‚ùå Delete failed: ' + error.message, 'danger');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
        videoToDeleteId = null;
    }
});

document.getElementById('confirmDeleteMaterial').addEventListener('click', async function() {
    if (!materialToDeleteId) return;
    
    const button = this;
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
        button.disabled = true;
        
        const response = await fetch(`/admin/delete_material/${materialToDeleteId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                // Remove material from DOM
                const materialItem = document.querySelector(`[data-material-id="${materialToDeleteId}"]`);
                if (materialItem) {
                    materialItem.remove();
                }
                
                // Update material count
                updateMaterialCount();
                
                // Show "no materials" message if no materials left
                const remainingMaterials = document.querySelectorAll('[data-material-id]');
                const noMaterialsMsg = document.getElementById('noMaterialsMessage');
                if (remainingMaterials.length === 0 && noMaterialsMsg) {
                    noMaterialsMsg.style.display = 'block';
                    // Remove empty list group
                    const listGroup = document.querySelector('.list-group');
                    if (listGroup) {
                        listGroup.remove();
                    }
                }
                
                // Close modal and show success
                bootstrap.Modal.getInstance(document.getElementById('deleteMaterialModal')).hide();
                showNotification('‚úÖ Material deleted successfully!', 'success');
            } else {
                throw new Error(result.error || 'Delete failed');
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('Delete error:', error);
        showNotification('‚ùå Delete failed: ' + error.message, 'danger');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
        materialToDeleteId = null;
    }
});

// Utility Functions
function updateVideoNumbers() {
    const videoItems = document.querySelectorAll('.video-item');
    videoItems.forEach((item, index) => {
        const badge = item.querySelector('.badge');
        if (badge) {
            badge.textContent = index + 1;
        }
    });
}

function editVideo(videoId) {
    // For now, just show an alert. You can implement a full edit modal later
    alert('Edit video functionality coming soon! Video ID: ' + videoId);
    
    // TODO: Implement edit video modal with form to update:
    // - title
    // - description
    // - duration
    // - order
}

function confirmDelete() {
    {% if course.get_enrolled_count() == 0 %}
        const modal = new bootstrap.Modal(document.getElementById('deleteCourseModal'));
        modal.show();
    {% else %}
        alert('‚ùå Cannot delete this course because it has enrolled students. Deactivate it instead.');
    {% endif %}
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// File Input Handlers
function setupFileInputHandlers() {
    // Video file input handler
    const fileInput = document.getElementById('videoFile');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fileInfoDiv = document.getElementById('fileInfo');
            
            if (file) {
                const fileSize = file.size / 1024 / 1024; // MB
                const maxSize = 500; // MB
                
                if (fileSize > maxSize) {
                    fileInfoDiv.className = 'form-text text-danger';
                    fileInfoDiv.innerHTML = `‚ùå File is too large (${fileSize.toFixed(1)}MB). Maximum size is ${maxSize}MB.`;
                    fileInfoDiv.style.display = 'block';
                    e.target.value = '';
                    return;
                }
                
                // Show file info
                fileInfoDiv.className = 'form-text text-success';
                fileInfoDiv.innerHTML = `‚úÖ File: ${file.name} (${fileSize.toFixed(1)}MB)`;
                fileInfoDiv.style.display = 'block';
                
                console.log('üìÅ File selected:', {
                    name: file.name,
                    size: `${fileSize.toFixed(1)}MB`,
                    type: file.type
                });
            } else {
                fileInfoDiv.style.display = 'none';
            }
        });
    }
    
    // Material file input handler
    const materialFileInput = document.getElementById('materialFile');
    if (materialFileInput) {
        materialFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            
            if (file) {
                const fileSize = file.size / 1024 / 1024; // MB
                const maxSize = 10; // MB
                
                if (fileSize > maxSize) {
                    alert(`‚ùå File is too large (${fileSize.toFixed(1)}MB). Maximum size is ${maxSize}MB.`);
                    e.target.value = '';
                    return;
                }
                
                // Auto-fill title if empty
                const titleInput = document.getElementById('materialTitle');
                if (titleInput && !titleInput.value.trim()) {
                    const fileName = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
                    titleInput.value = fileName;
                }
                
                console.log('üìÑ Material file selected:', {
                    name: file.name,
                    size: `${fileSize.toFixed(1)}MB`,
                    type: file.type
                });
            }
        });
    }
}

// Additional Form Validation
document.getElementById('image_url').addEventListener('input', function(e) {
    const url = e.target.value;
    if (url && url.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
        console.log('Valid image URL:', url);
    }
});

// Price formatting
document.getElementById('price').addEventListener('blur', function(e) {
    const value = parseFloat(e.target.value);
    if (!isNaN(value)) {
        e.target.value = value.toFixed(2);
    }
});

// Character counter for short description
document.getElementById('short_description').addEventListener('input', function(e) {
    const maxLength = 500;
    const currentLength = e.target.value.length;
    const remaining = maxLength - currentLength;
    
    let counterElement = document.getElementById('char-counter');
    if (!counterElement) {
        counterElement = document.createElement('small');
        counterElement.id = 'char-counter';
        counterElement.className = 'form-text';
        e.target.parentNode.appendChild(counterElement);
    }
    
    counterElement.textContent = `${currentLength}/${maxLength} characters`;
    counterElement.className = remaining < 50 ? 'form-text text-warning' : 'form-text text-muted';
    
    if (remaining < 0) {
        counterElement.className = 'form-text text-danger';
        counterElement.textContent = `${Math.abs(remaining)} characters over limit`;
    }
});

// Auto-save draft functionality (optional)
let autoSaveTimeout;
function autoSaveDraft() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        const formData = new FormData(document.getElementById('editCourseForm'));
        const draftData = {};
        
        for (let [key, value] of formData.entries()) {
            draftData[key] = value;
        }
        
        // Save to sessionStorage (not localStorage as per restrictions)
        try {
            sessionStorage.setItem('course_draft_{{ course.id }}', JSON.stringify(draftData));
            console.log('üìù Draft auto-saved');
        } catch (error) {
            console.log('Could not save draft:', error);
        }
    }, 2000);
}

// Auto-save on input changes
document.getElementById('editCourseForm').addEventListener('input', autoSaveDraft);

// Load draft on page load (if exists)
window.addEventListener('load', function() {
    try {
        const savedDraft = sessionStorage.getItem('course_draft_{{ course.id }}');
        if (savedDraft) {
            console.log('üìù Found saved draft');
            // Optional: Ask user if they want to restore the draft
            // For now, just log that it exists
        }
    } catch (error) {
        console.log('Could not load draft:', error);
    }
});

// Clear draft when form is successfully submitted
document.getElementById('editCourseForm').addEventListener('submit', function() {
    try {
        sessionStorage.removeItem('course_draft_{{ course.id }}');
        console.log('üìù Draft cleared after successful submission');
    } catch (error) {
        console.log('Could not clear draft:', error);
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + S to save
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        document.getElementById('updateBtn').click();
    }
    
    // Escape to close forms
    if (e.key === 'Escape') {
        const addVideoForm = document.getElementById('addVideoForm');
        const addMaterialForm = document.getElementById('addMaterialForm');
        
        if (addVideoForm && addVideoForm.style.display === 'block') {
            hideAddVideoForm();
        }
        
        if (addMaterialForm && addMaterialForm.style.display === 'block') {
            hideAddMaterialForm();
        }
    }
});

// Video preview functionality (optional enhancement)
function previewVideo(videoUrl) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Video Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <video controls style="width: 100%; max-height: 400px;">
                        <source src="${videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
    
    bootstrapModal.show();
}

// Enhanced form validation with real-time feedback
function setupFormValidation() {
    const requiredFields = [
        { id: 'title', name: 'Course Title' },
        { id: 'description', name: 'Description' },
        { id: 'category', name: 'Category' },
        { id: 'level', name: 'Level' },
        { id: 'price', name: 'Price' }
    ];
    
    requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element) {
            element.addEventListener('blur', function() {
                validateField(element, field.name);
            });
        }
    });
}

function validateField(element, fieldName) {
    const value = element.value.trim();
    let feedback = element.parentNode.querySelector('.field-feedback');
    
    if (!feedback) {
        feedback = document.createElement('div');
        feedback.className = 'field-feedback';
        element.parentNode.appendChild(feedback);
    }
    
    if (!value) {
        element.classList.add('is-invalid');
        element.classList.remove('is-valid');
        feedback.className = 'field-feedback text-danger small';
        feedback.textContent = `${fieldName} is required`;
    } else {
        element.classList.remove('is-invalid');
        element.classList.add('is-valid');
        feedback.className = 'field-feedback text-success small';
        feedback.textContent = `${fieldName} looks good`;
    }
}

// Initialize form validation
setupFormValidation();

// Loading state management
function setLoadingState(button, isLoading, loadingText = 'Loading...') {
    if (isLoading) {
        button.dataset.originalText = button.innerHTML;
        button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>${loadingText}`;
        button.disabled = true;
    } else {
        button.innerHTML = button.dataset.originalText || button.innerHTML;
        button.disabled = false;
    }
}

// Enhanced error handling
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    showNotification('‚ùå An unexpected error occurred. Please try again.', 'danger');
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('Unhandled promise rejection:', e.reason);
    showNotification('‚ùå An unexpected error occurred. Please try again.', 'danger');
});

// Performance monitoring
if (window.performance && window.performance.measure) {
    window.addEventListener('load', function() {
        setTimeout(() => {
            const loadTime = window.performance.timing.loadEventEnd - window.performance.timing.navigationStart;
            console.log(`üìä Page load time: ${loadTime}ms`);
        }, 0);
    });
}

// Cleanup function for when user leaves the page
window.addEventListener('beforeunload', function(e) {
    // Cancel any ongoing uploads
    const uploadBtn = document.getElementById('uploadVideoBtn');
    const materialBtn = document.getElementById('uploadMaterialBtn');
    
    if (uploadBtn && uploadBtn.disabled) {
        e.preventDefault();
        e.returnValue = 'Video upload in progress. Are you sure you want to leave?';
    }
    
    if (materialBtn && materialBtn.disabled) {
        e.preventDefault();
        e.returnValue = 'Material upload in progress. Are you sure you want to leave?';
    }
});

console.log('‚úÖ Edit course page fully loaded and initialized');
</script>
{% endblock %}
