<!-- templates/admin_projects.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Student Projects - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .admin-header { 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px); 
            color: white; 
            padding: 2rem 0; 
            margin-bottom: 2rem; 
        }
        .stats-card { 
            background: white; 
            border-radius: 15px; 
            padding: 1.5rem; 
            text-align: center; 
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .stats-card:hover { transform: translateY(-2px); }
        .stats-card h3 { 
            font-size: 2rem; 
            font-weight: bold; 
            margin-bottom: 0.5rem;
        }
        .stats-card .icon { 
            font-size: 2.5rem; 
            margin-bottom: 1rem;
        }
        .filters-section { 
            background: white; 
            border-radius: 15px; 
            padding: 1.5rem; 
            margin-bottom: 2rem; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .project-table { 
            background: white; 
            border-radius: 15px; 
            overflow: hidden; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .table th { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            border: none; 
            font-weight: 600;
            padding: 1rem;
        }
        .table td { 
            padding: 1rem; 
            vertical-align: middle; 
            border-color: #f8f9fa;
        }
        .project-thumbnail { 
            width: 60px; 
            height: 60px; 
            object-fit: cover; 
            border-radius: 8px;
        }
        .project-placeholder { 
            width: 60px; 
            height: 60px; 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white;
        }
        .status-badge { 
            padding: 0.35rem 0.75rem; 
            border-radius: 15px; 
            font-size: 0.8rem; 
            font-weight: bold;
        }
        .status-active { 
            background: #d4edda; 
            color: #155724;
        }
        .status-inactive { 
            background: #f8d7da; 
            color: #721c24;
        }
        .featured-badge { 
            background: linear-gradient(45deg, #ff6b6b, #ffa500); 
            color: white; 
            padding: 0.25rem 0.5rem; 
            border-radius: 10px; 
            font-size: 0.7rem; 
            font-weight: bold;
        }
        .engagement-stats { 
            display: flex; 
            gap: 0.75rem; 
            font-size: 0.85rem;
        }
        .stat-item { 
            display: flex; 
            align-items: center; 
            gap: 0.25rem;
        }
        .btn-toggle { 
            border: none; 
            background: transparent; 
            padding: 0.25rem; 
            border-radius: 4px; 
            transition: all 0.3s ease;
        }
        .btn-toggle:hover { 
            background: #f8f9fa; 
            transform: scale(1.1);
        }
        .btn-custom { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            border: none; 
            color: white; 
            border-radius: 20px; 
            padding: 0.5rem 1rem; 
            transition: all 0.3s ease;
        }
        .btn-custom:hover { 
            background: linear-gradient(45deg, #764ba2, #667eea); 
            color: white;
        }
        .student-info { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem;
        }
        .student-avatar { 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold; 
            font-size: 0.8rem;
        }
        .project-actions { 
            display: flex; 
            gap: 0.25rem; 
            align-items: center;
        }
        .no-projects { 
            text-align: center; 
            padding: 3rem; 
            color: #6c757d;
        }
        .bulk-actions { 
            background: #f8f9fa; 
            border-radius: 10px; 
            padding: 1rem; 
            margin-bottom: 1rem; 
            display: none;
        }
        .bulk-actions.show { display: block; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{{ url_for('main.index') }}">
                <i class="fas fa-rocket me-2"></i>BuXin Future Academy
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('admin_projects') }}">
                            <i class="fas fa-project-diagram me-1"></i>Student Projects
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('student_projects') }}">
                            <i class="fas fa-eye me-1"></i>View Public
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_users') }}">Users</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_courses') }}">Courses</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Admin Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="fas fa-cogs me-3"></i>Student Projects Management
                    </h1>
                    <p class="lead mb-0">
                        Monitor, moderate, and showcase student creativity
                    </p>
                </div>
                <div class="col-lg-4">
                    <div class="row">
                        <div class="col-6">
                            <div class="stats-card text-center" style="background: rgba(255,255,255,0.2); color: white;">
                                <h3>{{ total_projects }}</h3>
                                <small>Total Projects</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stats-card text-center" style="background: rgba(255,255,255,0.2); color: white;">
                                <h3>{{ featured_projects }}</h3>
                                <small>Featured</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Statistics Dashboard -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="icon text-primary">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <h3 class="text-primary">{{ total_projects }}</h3>
                    <p class="text-muted mb-0">Total Projects</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="icon text-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 class="text-success">{{ active_projects }}</h3>
                    <p class="text-muted mb-0">Active Projects</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="icon text-warning">
                        <i class="fas fa-star"></i>
                    </div>
                    <h3 class="text-warning">{{ featured_projects }}</h3>
                    <p class="text-muted mb-0">Featured</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="icon text-danger">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <h3 class="text-danger">{{ total_projects - active_projects }}</h3>
                    <p class="text-muted mb-0">Inactive</p>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="filters-section">
            <form method="GET" action="{{ url_for('admin_projects') }}">
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <label class="form-label"><i class="fas fa-search me-1"></i>Search Projects</label>
                        <input type="text" class="form-control" name="search" 
                               value="{{ search_term }}" placeholder="Search by title, description, or student...">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label"><i class="fas fa-filter me-1"></i>Status</label>
                        <select class="form-select" name="status">
                            <option value="">All Status</option>
                            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label"><i class="fas fa-star me-1"></i>Featured</label>
                        <select class="form-select" name="featured">
                            <option value="">All Projects</option>
                            <option value="true" {% if featured_filter == 'true' %}selected{% endif %}>Featured Only</option>
                            <option value="false" {% if featured_filter == 'false' %}selected{% endif %}>Not Featured</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label"><i class="fas fa-sort me-1"></i>Sort By</label>
                        <select class="form-select" name="sort">
                            <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Newest First</option>
                            <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Title A-Z</option>
                            <option value="student" {% if sort_by == 'student' %}selected{% endif %}>Student Name</option>
                            <option value="popular" {% if sort_by == 'popular' %}selected{% endif %}>Most Popular</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-custom w-100">
                            <i class="fas fa-search me-1"></i>Apply
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Bulk Actions (Hidden by default) -->
        <div class="bulk-actions" id="bulk-actions">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong><span id="selected-count">0</span> projects selected</strong>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success btn-sm" onclick="bulkAction('activate')">
                        <i class="fas fa-check me-1"></i>Activate
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="bulkAction('deactivate')">
                        <i class="fas fa-times me-1"></i>Deactivate
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="bulkAction('feature')">
                        <i class="fas fa-star me-1"></i>Feature
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="bulkAction('unfeature')">
                        <i class="fas fa-star-half-alt me-1"></i>Unfeature
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Projects Table -->
        {% if projects %}
            <div class="project-table">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                            </th>
                            <th style="width: 80px;">Image</th>
                            <th>Project Details</th>
                            <th>Student</th>
                            <th>Engagement</th>
                            <th>Status</th>
                            <th style="width: 200px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="project-checkbox" value="{{ project.id }}" 
                                           onchange="updateBulkActions()">
                                </td>
                                <td>
                                    {% if project.image_url %}
                                        <img src="{{ project.image_url }}" alt="{{ project.title }}" class="project-thumbnail">
                                    {% else %}
                                        <div class="project-placeholder">
                                            <i class="fas fa-project-diagram"></i>
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>
                                        <h6 class="mb-1">
                                            {{ project.title }}
                                            {% if project.featured %}
                                                <span class="featured-badge ms-2">
                                                    <i class="fas fa-star me-1"></i>Featured
                                                </span>
                                            {% endif %}
                                        </h6>
                                        <p class="text-muted mb-1 small">
                                            {{ project.description[:100] }}{% if project.description|length > 100 %}...{% endif %}
                                        </p>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>
                                            {{ project.created_at.strftime('%B %d, %Y') }}
                                            {% if project.youtube_url %}
                                                <i class="fab fa-youtube text-danger ms-2"></i>
                                            {% endif %}
                                            {% if project.project_link %}
                                                <i class="fas fa-external-link-alt text-primary ms-1"></i>
                                            {% endif %}
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    <div class="student-info">
                                        <div class="student-avatar">
                                            {{ project.student.first_name[0] }}{{ project.student.last_name[0] }}
                                        </div>
                                        <div>
                                            <div class="fw-bold small">{{ project.student.first_name }} {{ project.student.last_name }}</div>
                                            <small class="text-muted">{{ project.student.username }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="engagement-stats">
                                        <div class="stat-item text-success">
                                            <i class="fas fa-thumbs-up"></i>
                                            <span>{{ project.get_like_count() }}</span>
                                        </div>
                                        <div class="stat-item text-danger">
                                            <i class="fas fa-thumbs-down"></i>
                                            <span>{{ project.get_dislike_count() }}</span>
                                        </div>
                                        <div class="stat-item text-primary">
                                            <i class="fas fa-comments"></i>
                                            <span>{{ project.get_comment_count() }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge {% if project.is_active %}status-active{% else %}status-inactive{% endif %}">
                                        <i class="fas {% if project.is_active %}fa-check-circle{% else %}fa-times-circle{% endif %} me-1"></i>
                                        {% if project.is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div class="project-actions">
                                        <!-- View Project -->
                                        <a href="{{ url_for('view_project', project_id=project.id) }}" 
                                           class="btn btn-outline-primary btn-sm" title="View Project">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        
                                        <!-- Toggle Active Status -->
                                        <button class="btn-toggle {% if project.is_active %}text-warning{% else %}text-success{% endif %}" 
                                                onclick="toggleProjectStatus({{ project.id }}, {{ 'false' if project.is_active else 'true' }})"
                                                title="{% if project.is_active %}Deactivate{% else %}Activate{% endif %} Project">
                                            <i class="fas {% if project.is_active %}fa-pause{% else %}fa-play{% endif %}"></i>
                                        </button>
                                        
                                        <!-- Toggle Featured Status -->
                                        <button class="btn-toggle {% if project.featured %}text-warning{% else %}text-muted{% endif %}" 
                                                onclick="toggleProjectFeatured({{ project.id }}, {{ 'false' if project.featured else 'true' }})"
                                                title="{% if project.featured %}Remove from{% else %}Add to{% endif %} Featured">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        
                                        <!-- Edit Project -->
                                        <a href="{{ url_for('edit_project', project_id=project.id) }}" 
                                           class="btn btn-outline-success btn-sm" title="Edit Project">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        
                                        <!-- Delete Project -->
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="confirmDelete({{ project.id }}, '{{ project.title }}')" 
                                                title="Delete Project">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="project-table">
                <div class="no-projects">
                    <i class="fas fa-folder-open fa-4x mb-3"></i>
                    <h4>No Projects Found</h4>
                    <p class="mb-0">
                        {% if search_term or status_filter or featured_filter %}
                            No projects match your current filters. <a href="{{ url_for('admin_projects') }}">Clear filters</a>
                        {% else %}
                            Students haven't created any projects yet.
                        {% endif %}
                    </p>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the project "<span id="delete-project-title"></span>"?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This will permanently delete:
                        <ul class="mb-0 mt-2">
                            <li>The project and all its content</li>
                            <li>All likes and dislikes</li>
                            <li>All comments from users</li>
                            <li>All uploaded images</li>
                        </ul>
                    </div>
                    <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <form method="POST" id="delete-form" style="display: inline;">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash me-1"></i>Delete Project
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Toggle project active status
        function toggleProjectStatus(projectId, newStatus) {
            fetch(`/admin/project/${projectId}/toggle-status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    is_active: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Refresh page to update UI
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }

        // Toggle project featured status
        function toggleProjectFeatured(projectId, newFeatured) {
            fetch(`/admin/project/${projectId}/toggle-featured`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    featured: newFeatured
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Refresh page to update UI
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }

        // Confirm project deletion
        function confirmDelete(projectId, projectTitle) {
            document.getElementById('delete-project-title').textContent = projectTitle;
            document.getElementById('delete-form').action = `/delete-project/${projectId}`;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        // Bulk selection functionality
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.project-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateBulkActions();
        }

        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.project-checkbox:checked');
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCount = document.getElementById('selected-count');
            
            if (checkboxes.length > 0) {
                bulkActions.classList.add('show');
                selectedCount.textContent = checkboxes.length;
            } else {
                bulkActions.classList.remove('show');
            }
            
            // Update select-all checkbox state
            const allCheckboxes = document.querySelectorAll('.project-checkbox');
            const selectAll = document.getElementById('select-all');
            selectAll.checked = checkboxes.length === allCheckboxes.length;
            selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
        }

        function clearSelection() {
            document.querySelectorAll('.project-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('select-all').checked = false;
            updateBulkActions();
        }

        function bulkAction(action) {
            const checkboxes = document.querySelectorAll('.project-checkbox:checked');
            const projectIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (projectIds.length === 0) {
                alert('Please select at least one project');
                return;
            }
            
            const actionNames = {
                'activate': 'activate',
                'deactivate': 'deactivate', 
                'feature': 'feature',
                'unfeature': 'unfeature'
            };
            
            if (confirm(`Are you sure you want to ${actionNames[action]} ${projectIds.length} project(s)?`)) {
                // Simulate bulk action (you would implement the actual API call)
                alert(`Bulk ${actionNames[action]} functionality would be implemented here for projects: ${projectIds.join(', ')}`);
                // location.reload(); // Refresh after action
            }
        }

        // Add hover effects to stats cards
        document.addEventListener('DOMContentLoaded', function() {
            const statCards = document.querySelectorAll('.stats-card');
            statCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
        });
    </script>
</body>
</html>


