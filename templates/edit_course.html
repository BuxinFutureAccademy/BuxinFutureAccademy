{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4><i class="fas fa-edit me-2"></i>‚úèÔ∏è Edit Course</h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('edit_course', course_id=course.id) }}" id="editCourseForm">
                        <!-- Course Preview -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                {% if course.image_url %}
                                    <img src="{{ course.image_url }}" class="img-fluid rounded shadow-sm" 
                                         alt="{{ course.title }}" style="max-height: 200px; width: 100%; object-fit: cover;">
                                {% else %}
                                    <div class="bg-gradient rounded d-flex align-items-center justify-content-center shadow-sm" 
                                         style="height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <i class="fas fa-graduation-cap fa-3x text-white"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-8">
                                <div class="course-stats">
                                    <h5 class="text-muted mb-3">üìä Course Statistics</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="stat-card bg-primary text-white p-3 rounded mb-2">
                                                <i class="fas fa-users fa-2x mb-2"></i>
                                                <h4>{{ course.get_enrolled_count() }}</h4>
                                                <small>Enrolled Students</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="stat-card bg-success text-white p-3 rounded mb-2">
                                                <i class="fas fa-play fa-2x mb-2"></i>
                                                <h4>{{ course.get_video_count() }}</h4>
                                                <small>Video Lessons</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="stat-card bg-info text-white p-3 rounded">
                                                <i class="fas fa-file fa-2x mb-2"></i>
                                                <h4>{{ course.materials|length }}</h4>
                                                <small>Course Materials</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="stat-card bg-warning text-dark p-3 rounded">
                                                <i class="fas fa-clock fa-2x mb-2"></i>
                                                <h4>{{ course.get_total_duration() or 'TBD' }}</h4>
                                                <small>Total Duration</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Basic Course Information -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>üìù Basic Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <label for="title" class="form-label">Course Title *</label>
                                        <input type="text" class="form-control" id="title" name="title" 
                                               value="{{ course.title }}" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="price" class="form-label">Price (GMD) *</label>
                                        <input type="number" class="form-control" id="price" name="price" 
                                               step="0.01" min="0" value="{{ course.price }}" required>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="short_description" class="form-label">Short Description</label>
                                    <input type="text" class="form-control" id="short_description" name="short_description" 
                                           value="{{ course.short_description or '' }}" maxlength="500"
                                           placeholder="Brief description for course cards">
                                    <div class="form-text">üìè Brief summary for course listings (max 500 characters)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label">Full Description *</label>
                                    <textarea class="form-control" id="description" name="description" rows="5" 
                                              placeholder="Detailed course description" required>{{ course.description }}</textarea>
                                    <div class="form-text">üìñ Detailed course description for the course page</div>
                                </div>
                            </div>
                        </div>

                        <!-- Course Categories and Settings -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-cog me-2"></i>‚öôÔ∏è Course Settings</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="category" class="form-label">Category *</label>
                                        <select class="form-select" id="category" name="category" required>
                                            <option value="">üéØ Select Category</option>
                                            <optgroup label="ü§ñ Technology & Engineering">
                                                <option value="Artificial Intelligence" {% if course.category == 'Artificial Intelligence' %}selected{% endif %}>ü§ñ Artificial Intelligence</option>
                                                <option value="Machine Learning" {% if course.category == 'Machine Learning' %}selected{% endif %}>üß† Machine Learning</option>
                                                <option value="Electronics Engineering" {% if course.category == 'Electronics Engineering' %}selected{% endif %}>‚ö° Electronics Engineering</option>
                                                <option value="Microcontrollers" {% if course.category == 'Microcontrollers' %}selected{% endif %}>üîå Microcontrollers</option>
                                                <option value="Robotics" {% if course.category == 'Robotics' %}selected{% endif %}>ü§ñ Robotics</option>
                                                <option value="IoT Development" {% if course.category == 'IoT Development' %}selected{% endif %}>üì° IoT Development</option>
                                            </optgroup>
                                            <optgroup label="üíª Programming & Development">
                                                <option value="Programming" {% if course.category == 'Programming' %}selected{% endif %}>üíª Programming</option>
                                                <option value="Web Development" {% if course.category == 'Web Development' %}selected{% endif %}>üåê Web Development</option>
                                                <option value="Mobile Development" {% if course.category == 'Mobile Development' %}selected{% endif %}>üì± Mobile Development</option>
                                                <option value="Data Science" {% if course.category == 'Data Science' %}selected{% endif %}>üìä Data Science</option>
                                                <option value="Cybersecurity" {% if course.category == 'Cybersecurity' %}selected{% endif %}>üîí Cybersecurity</option>
                                                <option value="Cloud Computing" {% if course.category == 'Cloud Computing' %}selected{% endif %}>‚òÅÔ∏è Cloud Computing</option>
                                            </optgroup>
                                            <optgroup label="üé® Design & Creative">
                                                <option value="UI/UX Design" {% if course.category == 'UI/UX Design' %}selected{% endif %}>üé® UI/UX Design</option>
                                                <option value="Graphic Design" {% if course.category == 'Graphic Design' %}selected{% endif %}>üñºÔ∏è Graphic Design</option>
                                                <option value="3D Modeling" {% if course.category == '3D Modeling' %}selected{% endif %}>üéØ 3D Modeling</option>
                                                <option value="Photography" {% if course.category == 'Photography' %}selected{% endif %}>üì∏ Photography</option>
                                                <option value="Video Editing" {% if course.category == 'Video Editing' %}selected{% endif %}>üé¨ Video Editing</option>
                                            </optgroup>
                                            <optgroup label="üìà Business & Marketing">
                                                <option value="Digital Marketing" {% if course.category == 'Digital Marketing' %}selected{% endif %}>üìà Digital Marketing</option>
                                                <option value="Business Strategy" {% if course.category == 'Business Strategy' %}selected{% endif %}>üíº Business Strategy</option>
                                                <option value="E-commerce" {% if course.category == 'E-commerce' %}selected{% endif %}>üõí E-commerce</option>
                                                <option value="Project Management" {% if course.category == 'Project Management' %}selected{% endif %}>üìã Project Management</option>
                                                <option value="Financial Analysis" {% if course.category == 'Financial Analysis' %}selected{% endif %}>üí∞ Financial Analysis</option>
                                            </optgroup>
                                            <optgroup label="üéµ Arts & Media">
                                                <option value="Music Production" {% if course.category == 'Music Production' %}selected{% endif %}>üéµ Music Production</option>
                                                <option value="Animation" {% if course.category == 'Animation' %}selected{% endif %}>üéûÔ∏è Animation</option>
                                                <option value="Content Creation" {% if course.category == 'Content Creation' %}selected{% endif %}>üìù Content Creation</option>
                                                <option value="Digital Art" {% if course.category == 'Digital Art' %}selected{% endif %}>üé® Digital Art</option>
                                            </optgroup>
                                            <optgroup label="üèóÔ∏è Engineering & Sciences">
                                                <option value="Mechanical Engineering" {% if course.category == 'Mechanical Engineering' %}selected{% endif %}>‚öôÔ∏è Mechanical Engineering</option>
                                                <option value="Civil Engineering" {% if course.category == 'Civil Engineering' %}selected{% endif %}>üèóÔ∏è Civil Engineering</option>
                                                <option value="Mathematics" {% if course.category == 'Mathematics' %}selected{% endif %}>üî¢ Mathematics</option>
                                                <option value="Physics" {% if course.category == 'Physics' %}selected{% endif %}>‚öõÔ∏è Physics</option>
                                                <option value="Chemistry" {% if course.category == 'Chemistry' %}selected{% endif %}>üß™ Chemistry</option>
                                            </optgroup>
                                            <optgroup label="üåç Languages & Communication">
                                                <option value="English Language" {% if course.category == 'English Language' %}selected{% endif %}>üá∫üá∏ English Language</option>
                                                <option value="French Language" {% if course.category == 'French Language' %}selected{% endif %}>üá´üá∑ French Language</option>
                                                <option value="Spanish Language" {% if course.category == 'Spanish Language' %}selected{% endif %}>üá™üá∏ Spanish Language</option>
                                                <option value="Communication Skills" {% if course.category == 'Communication Skills' %}selected{% endif %}>üí¨ Communication Skills</option>
                                                <option value="Public Speaking" {% if course.category == 'Public Speaking' %}selected{% endif %}>üé§ Public Speaking</option>
                                            </optgroup>
                                            <optgroup label="üìö Academic & General">
                                                <option value="Study Skills" {% if course.category == 'Study Skills' %}selected{% endif %}>üìñ Study Skills</option>
                                                <option value="Research Methods" {% if course.category == 'Research Methods' %}selected{% endif %}>üîç Research Methods</option>
                                                <option value="Critical Thinking" {% if course.category == 'Critical Thinking' %}selected{% endif %}>üß© Critical Thinking</option>
                                                <option value="Other" {% if course.category == 'Other' %}selected{% endif %}>üì¶ Other</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="level" class="form-label">Level *</label>
                                        <select class="form-select" id="level" name="level" required>
                                            <option value="">üìö Select Level</option>
                                            <option value="Beginner" {% if course.level == 'Beginner' %}selected{% endif %}>üå± Beginner</option>
                                            <option value="Intermediate" {% if course.level == 'Intermediate' %}selected{% endif %}>üìà Intermediate</option>
                                            <option value="Advanced" {% if course.level == 'Advanced' %}selected{% endif %}>üöÄ Advanced</option>
                                            <option value="Expert" {% if course.level == 'Expert' %}selected{% endif %}>üèÜ Expert</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="duration_weeks" class="form-label">Duration (weeks)</label>
                                        <input type="number" class="form-control" id="duration_weeks" name="duration_weeks" 
                                               value="{{ course.duration_weeks }}" min="1" max="52">
                                        <div class="form-text">‚è±Ô∏è Expected completion time</div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="image_url" class="form-label">Course Image URL</label>
                                    <input type="url" class="form-control" id="image_url" name="image_url" 
                                           value="{{ course.image_url or '' }}" placeholder="https://example.com/image.jpg">
                                    <div class="form-text">üñºÔ∏è Course thumbnail image (recommended: 400x300px)</div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                                   {% if course.is_active %}checked{% endif %}>
                                            <label class="form-check-label" for="is_active">
                                                ‚úÖ Course is active (visible in store)
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="featured" name="featured" 
                                                   {% if course.featured %}checked{% endif %}>
                                            <label class="form-check-label" for="featured">
                                                ‚≠ê Featured course (appears in highlights)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Videos Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-play me-2"></i>üé¨ Video Lessons</h5>
                                <button type="button" class="btn btn-success btn-sm" onclick="showAddVideoForm()">
                                    <i class="fas fa-plus me-1"></i>üìπ Add Video
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Existing Videos -->
                                <div id="videosList">
                                    {% if course.videos %}
                                        {% for video in course.videos %}
                                            <div class="video-item border rounded p-3 mb-3" data-video-id="{{ video.id }}">
                                                <div class="row align-items-center">
                                                    <div class="col-md-1">
                                                        <span class="badge bg-primary fs-6">{{ loop.index }}</span>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6 class="mb-1">{{ video.title }}</h6>
                                                        {% if video.description %}
                                                            <small class="text-muted">{{ video.description[:100] }}{% if video.description|length > 100 %}...{% endif %}</small>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-2">
                                                        {% if video.duration %}
                                                            <small class="text-muted">
                                                                <i class="fas fa-clock me-1"></i>{{ video.duration }}
                                                            </small>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-3 text-end">
                                                        <div class="btn-group">
                                                            {% if video.video_url %}
                                                                <a href="{{ video.video_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                                    <i class="fas fa-play me-1"></i>Play
                                                                </a>
                                                            {% else %}
                                                                <a href="{{ url_for('course_video', filename=video.video_filename) }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                                    <i class="fas fa-play me-1"></i>Play
                                                                </a>
                                                            {% endif %}
                                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteVideo({{ video.id }}, '{{ video.title|replace("'", "\\'") }}')">
                                                                <i class="fas fa-trash me-1"></i>Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center py-4" id="noVideosMessage">
                                            <i class="fas fa-video fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">No videos uploaded yet</h5>
                                            <p class="text-muted">Click "Add Video" to upload your first lesson</p>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Add Video Form -->
                                <div id="addVideoForm" class="border rounded p-4 mt-3" style="display: none; background: #f8f9fa;">
                                    <h6 class="mb-3">üìπ Add New Video Lesson</h6>
                                    <form id="videoUploadForm" enctype="multipart/form-data">
                                        <input type="hidden" name="course_id" value="{{ course.id }}">
                                        <div class="row">
                                            <div class="col-md-8 mb-3">
                                                <label for="videoTitle" class="form-label">Lesson Title *</label>
                                                <input type="text" class="form-control" id="videoTitle" name="video_title" required>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="videoOrder" class="form-label">Order</label>
                                                <input type="number" class="form-control" id="videoOrder" name="video_order" min="1" value="{{ course.videos|length + 1 }}">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-8 mb-3">
                                                <label for="videoFile" class="form-label">Video File *</label>
                                                <input type="file" class="form-control" id="videoFile" name="video_file" 
                                                       accept=".mp4,.avi,.mov,.wmv,.flv,.webm,.mkv" required>
                                                <div class="form-text">üìã Supported: MP4, AVI, MOV, WMV, FLV, WebM, MKV (Max 500MB)</div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="videoDuration" class="form-label">Duration (optional)</label>
                                                <input type="text" class="form-control" id="videoDuration" name="video_duration" 
                                                       placeholder="e.g., 10:30">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="videoDescription" class="form-label">Lesson Description</label>
                                            <textarea class="form-control" id="videoDescription" name="video_description" rows="3"></textarea>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-success" id="uploadVideoBtn">
                                                <i class="fas fa-upload me-1"></i>üì§ Upload Video
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="hideAddVideoForm()">
                                                <i class="fas fa-times me-1"></i>Cancel
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Materials Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-file me-2"></i>üìÅ Course Materials</h5>
                                <button type="button" class="btn btn-success btn-sm" onclick="showAddMaterialForm()">
                                    <i class="fas fa-plus me-1"></i>üìÑ Add Material
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="materialsList">
                                    {% if course.materials %}
                                        <div class="list-group">
                                            {% for material in course.materials %}
                                                <div class="list-group-item d-flex justify-content-between align-items-center" data-material-id="{{ material.id }}">
                                                    <div>
                                                        <strong>{{ material.title }}</strong>
                                                        <br><small class="text-muted">{{ material.file_type.upper() }} - {{ material.get_file_size_mb() }} MB</small>
                                                    </div>
                                                    <div class="btn-group">
                                                        <a href="{{ url_for('course_material', filename=material.filename) }}" 
                                                           class="btn btn-outline-primary btn-sm" target="_blank">
                                                            <i class="fas fa-download me-1"></i>Download
                                                        </a>
                                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                onclick="deleteMaterial({{ material.id }}, '{{ material.title|replace("'", "\\'") }}')">
                                                            <i class="fas fa-trash me-1"></i>Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="text-muted text-center py-3" id="noMaterialsMessage">
                                            <i class="fas fa-file fa-2x mb-2"></i>
                                            <p>No materials uploaded yet</p>
                                            <p><small>Click "Add Material" to upload course resources</small></p>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Add Material Form -->
                                <div id="addMaterialForm" class="border rounded p-4 mt-3" style="display: none; background: #f8f9fa;">
                                    <h6 class="mb-3">üìÑ Add Course Material</h6>
                                    <form id="materialUploadForm" enctype="multipart/form-data">
                                        <input type="hidden" name="course_id" value="{{ course.id }}">
                                        <div class="row">
                                            <div class="col-md-8 mb-3">
                                                <label for="materialTitle" class="form-label">Material Title *</label>
                                                <input type="text" class="form-control" id="materialTitle" name="material_title" required>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="materialFile" class="form-label">File *</label>
                                                <input type="file" class="form-control" id="materialFile" name="material_file" 
                                                       accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.zip,.rar" required>
                                                <div class="form-text">üìã Supported: PDF, DOC, PPT, TXT, ZIP (Max 10MB)</div>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-success" id="uploadMaterialBtn">
                                                <i class="fas fa-upload me-1"></i>üì§ Upload Material
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="hideAddMaterialForm()">
                                                <i class="fas fa-times me-1"></i>Cancel
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-warning btn-lg" id="updateBtn">
                                    <i class="fas fa-save me-2"></i>üíæ Update Course
                                </button>
                                <a href="{{ url_for('admin_courses') }}" class="btn btn-secondary btn-lg">
                                    <i class="fas fa-arrow-left me-2"></i>‚¨ÖÔ∏è Back to Courses
                                </a>
                            </div>
                            <div>
                                <a href="{{ url_for('course_detail', course_id=course.id) }}" class="btn btn-outline-primary btn-lg" target="_blank">
                                    <i class="fas fa-eye me-2"></i>üëÅÔ∏è Preview Course
                                </a>
                                {% if course.get_enrolled_count() == 0 %}
                                    <button type="button" class="btn btn-outline-danger btn-lg" onclick="confirmDelete()">
                                        <i class="fas fa-trash me-2"></i>üóëÔ∏è Delete Course
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stat-card {
    text-align: center;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-card h4 {
    margin: 0;
    font-weight: bold;
}

.form-switch .form-check-input {
    width: 3rem;
    height: 1.5rem;
}

.video-item {
    transition: all 0.2s ease;
    border-left: 4px solid transparent !important;
    background: white;
}

.video-item:hover {
    border-left-color: #007bff !important;
    background-color: rgba(0, 123, 255, 0.05);
}

.card-header h5 {
    font-weight: 600;
}

.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
}

optgroup {
    font-weight: bold;
    font-size: 0.9rem;
}

optgroup option {
    font-weight: normal;
    padding-left: 1rem;
}

.bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

#addVideoForm {
    border: 2px dashed #007bff;
}

#addMaterialForm {
    border: 2px dashed #28a745;
}

.btn-group .btn {
    margin-right: 2px;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

.list-group-item {
    transition: all 0.2s ease;
}

.list-group-item:hover {
    background-color: rgba(0, 123, 255, 0.05);
}
</style>

<script>
// Simplified JavaScript for Edit Course Form
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('editCourseForm');
    const updateBtn = document.getElementById('updateBtn');
    
    // Simple form submission - just show loading state
    form.addEventListener('submit', function(e) {
        updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
        updateBtn.disabled = true;
        // Let the form submit normally
    });
    
    // Video upload form handler
    const videoUploadForm = document.getElementById('videoUploadForm');
    if (videoUploadForm) {
        videoUploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadVideo();
        });
    }
    
    // Material upload form handler
    const materialUploadForm = document.getElementById('materialUploadForm');
    if (materialUploadForm) {
        materialUploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadMaterial();
        });
    }
});

// Video/Material Form Functions
function showAddVideoForm() {
    document.getElementById('addVideoForm').style.display = 'block';
    document.getElementById('videoTitle').focus();
}

function hideAddVideoForm() {
    document.getElementById('addVideoForm').style.display = 'none';
    document.getElementById('videoUploadForm').reset();
}

function showAddMaterialForm() {
    document.getElementById('addMaterialForm').style.display = 'block';
    document.getElementById('materialTitle').focus();
}

function hideAddMaterialForm() {
    document.getElementById('addMaterialForm').style.display = 'none';
    document.getElementById('materialUploadForm').reset();
}

// Delete Functions
function deleteVideo(videoId, videoTitle) {
    if (confirm('Are you sure you want to delete "' + videoTitle + '"?')) {
        fetch('/admin/delete_video/' + videoId, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('[data-video-id="' + videoId + '"]').remove();
                alert('‚úÖ Video deleted successfully!');
                location.reload();
            } else {
                alert('‚ùå Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('‚ùå Delete failed: ' + error.message);
        });
    }
}

function deleteMaterial(materialId, materialTitle) {
    if (confirm('Are you sure you want to delete "' + materialTitle + '"?')) {
        fetch('/admin/delete_material/' + materialId, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('[data-material-id="' + materialId + '"]').remove();
                alert('‚úÖ Material deleted successfully!');
                location.reload();
            } else {
                alert('‚ùå Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('‚ùå Delete failed: ' + error.message);
        });
    }
}

function confirmDelete() {
    if (confirm('‚ö†Ô∏è Are you sure you want to delete this entire course? This cannot be undone!')) {
        // Submit the delete form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("delete_course", course_id=course.id) }}';
        document.body.appendChild(form);
        form.submit();
    }
}

// Upload Functions
async function uploadVideo() {
    const form = document.getElementById('videoUploadForm');
    const formData = new FormData(form);
    const uploadBtn = document.getElementById('uploadVideoBtn');
    
    // Basic validation
    const title = formData.get('video_title').trim();
    const file = formData.get('video_file');
    
    if (!title) {
        alert('‚ùå Please provide a video title');
        return;
    }
    
    if (!file || file.size === 0) {
        alert('‚ùå Please select a video file');
        return;
    }
    
    // Check file size (500MB limit)
    const maxSize = 500 * 1024 * 1024;
    if (file.size > maxSize) {
        alert('‚ùå Video file is too large (' + (file.size / 1024 / 1024).toFixed(1) + 'MB). Maximum size is 500MB.');
        return;
    }
    
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';
    uploadBtn.disabled = true;
    
    try {
        const response = await fetch('/admin/add_video_to_course', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const contentType = response.headers.get('content-type');
            
            if (contentType && contentType.includes('application/json')) {
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Video uploaded successfully!');
                    location.reload();
                } else {
                    alert('‚ùå Upload failed: ' + result.error);
                }
            } else {
                alert('‚ùå Server returned an error page instead of JSON response');
            }
        } else {
            alert('‚ùå HTTP Error: ' + response.status + ' ' + response.statusText);
        }
        
    } catch (error) {
        alert('‚ùå Upload failed: ' + error.message);
    } finally {
        uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i>üì§ Upload Video';
        uploadBtn.disabled = false;
    }
}

async function uploadMaterial() {
    const form = document.getElementById('materialUploadForm');
    const formData = new FormData(form);
    const uploadBtn = document.getElementById('uploadMaterialBtn');
    
    // Basic validation
    const title = formData.get('material_title').trim();
    const file = formData.get('material_file');
    
    if (!title) {
        alert('‚ùå Please provide a material title');
        return;
    }
    
    if (!file || file.size === 0) {
        alert('‚ùå Please select a file');
        return;
    }
    
    // Check file size (10MB limit for materials)
    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
        alert('‚ùå File is too large (' + (file.size / 1024 / 1024).toFixed(1) + 'MB). Maximum size is 10MB.');
        return;
    }
    
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';
    uploadBtn.disabled = true;
    
    try {
        const response = await fetch('/admin/add_material_to_course', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                alert('‚úÖ Material uploaded successfully!');
                location.reload();
            } else {
                alert('‚ùå Upload failed: ' + result.error);
            }
        } else {
            alert('‚ùå HTTP Error: ' + response.status + ' ' + response.statusText);
        }
        
    } catch (error) {
        alert('‚ùå Upload failed: ' + error.message);
    } finally {
        uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i>üì§ Upload Material';
        uploadBtn.disabled = false;
    }
}

// File input handlers for validation
document.getElementById('videoFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const fileSize = file.size / 1024 / 1024; // MB
        const maxSize = 500; // MB
        
        if (fileSize > maxSize) {
            alert('‚ùå File is too large (' + fileSize.toFixed(1) + 'MB). Maximum size is ' + maxSize + 'MB.');
            e.target.value = '';
        }
    }
});

document.getElementById('materialFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const fileSize = file.size / 1024 / 1024; // MB
        const maxSize = 10; // MB
        
        if (fileSize > maxSize) {
            alert('‚ùå File is too large (' + fileSize.toFixed(1) + 'MB). Maximum size is ' + maxSize + 'MB.');
            e.target.value = '';
            return;
        }
        
        // Auto-fill title if empty
        const titleInput = document.getElementById('materialTitle');
        if (titleInput && !titleInput.value.trim()) {
            const fileName = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
            titleInput.value = fileName;
        }
    }
});

// Price formatting
document.getElementById('price').addEventListener('blur', function(e) {
    const value = parseFloat(e.target.value);
    if (!isNaN(value)) {
        e.target.value = value.toFixed(2);
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + S to save
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        document.getElementById('updateBtn').click();
    }
    
    // Escape to close forms
    if (e.key === 'Escape') {
        const addVideoForm = document.getElementById('addVideoForm');
        const addMaterialForm = document.getElementById('addMaterialForm');
        
        if (addVideoForm && addVideoForm.style.display === 'block') {
            hideAddVideoForm();
        }
        
        if (addMaterialForm && addMaterialForm.style.display === 'block') {
            hideAddMaterialForm();
        }
    }
});

console.log('‚úÖ Simplified edit course page loaded');
