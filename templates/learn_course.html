{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Course Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="card-title mb-2">{{ course.title }}</h3>
                            <p class="card-text">{{ course.short_description or course.description[:100] + '...' }}</p>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-light text-dark me-2">{{ course.category }}</span>
                                <span class="badge bg-success me-2">{{ course.level }}</span>
                                {% if videos and videos|length > 0 %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-play me-1"></i>{{ videos|length }} lessons
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{{ url_for('my_courses') }}" class="btn btn-light">
                                <i class="fas fa-arrow-left me-2"></i>Back to My Courses
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Course Content -->
        <div class="col-md-8">
            {% if videos and videos|length > 0 %}
                <!-- Video Player Section -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-play text-primary me-2"></i>
                            <span id="currentVideoTitle">{{ videos[0].title }}</span>
                        </h5>
                        <span class="badge bg-secondary" id="videoCounter">1 of {{ videos|length }}</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="video-container">
                            <video id="courseVideo" class="w-100" controls style="max-height: 500px; background: #000;">
                                <!-- Use Cloudinary URL if available, otherwise fallback to local route -->
                                {% if videos[0].video_url %}
                                    <source src="{{ videos[0].video_url }}" type="video/mp4">
                                {% else %}
                                    <source src="{{ url_for('course_video', filename=videos[0].video_filename) }}" type="video/mp4">
                                {% endif %}
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <button class="btn btn-outline-secondary" id="prevBtn" disabled>
                                <i class="fas fa-chevron-left me-2"></i>Previous
                            </button>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary" id="playPauseBtn">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-outline-secondary" id="fullscreenBtn">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                            <button class="btn btn-primary" id="nextBtn">
                                Next<i class="fas fa-chevron-right ms-2"></i>
                            </button>
                        </div>
                        <div class="mt-3">
                            <p class="text-muted mb-0" id="currentVideoDescription">{{ videos[0].description or "No description available." }}</p>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- No Videos Message -->
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <i class="fas fa-book fa-4x text-muted mb-3"></i>
                        <h4>Text-Based Course</h4>
                        <p class="text-muted">This course consists of reading materials and downloadable resources.</p>
                    </div>
                </div>
            {% endif %}

            <!-- Course Description -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-info me-2"></i>About This Course
                    </h5>
                </div>
                <div class="card-body">
                    <p>{{ course.description }}</p>
                    
                    {% if materials and materials|length > 0 %}
                        <h6 class="mt-4 mb-3">
                            <i class="fas fa-download text-warning me-2"></i>Course Materials
                        </h6>
                        <div class="row">
                            {% for material in materials %}
                                <div class="col-md-6 mb-2">
                                    <a href="{{ url_for('course_material', filename=material.filename) }}" 
                                       class="btn btn-outline-primary btn-sm w-100" target="_blank">
                                        <i class="fas fa-file-{{ material.file_type }} me-2"></i>{{ material.title }}
                                        <small class="text-muted">({{ material.get_file_size_mb() }} MB)</small>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No additional materials available for this course.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Progress Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line text-success me-2"></i>Your Progress
                    </h6>
                </div>
                <div class="card-body text-center">
                    <div class="progress-circle mb-3">
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%" 
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="overallProgress"></div>
                        </div>
                    </div>
                    <h4 class="text-success" id="progressPercentage">0%</h4>
                    <p class="text-muted">Course Completed</p>
                    {% if videos and videos|length > 0 %}
                        <small class="text-muted">
                            <span id="completedLessons">0</span> of {{ videos|length }} lessons completed
                        </small>
                    {% else %}
                        <small class="text-muted">
                            Text-based course - read materials below
                        </small>
                    {% endif %}
                </div>
            </div>

            <!-- Course Curriculum -->
            {% if videos and videos|length > 0 %}
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-list text-primary me-2"></i>Course Curriculum
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            {% for video in videos %}
                                <a href="#" class="list-group-item list-group-item-action video-item" 
                                   data-video-index="{{ loop.index0 }}"
                                   data-video-src="{% if video.video_url %}{{ video.video_url }}{% else %}{{ url_for('course_video', filename=video.video_filename) }}{% endif %}"
                                   data-video-title="{{ video.title }}"
                                   data-video-description="{{ video.description or 'No description available.' }}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">
                                                <span class="lesson-number">{{ loop.index }}.</span>
                                                {{ video.title }}
                                            </h6>
                                            {% if video.duration %}
                                                <small class="text-muted">
                                                    <i class="fas fa-clock me-1"></i>{{ video.duration }}
                                                </small>
                                            {% endif %}
                                        </div>
                                        <div class="lesson-status">
                                            <i class="fas fa-play text-muted"></i>
                                        </div>
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-book fa-3x text-muted mb-3"></i>
                        <h6>Reading Materials</h6>
                        <p class="text-muted">This course consists of reading materials and downloadable resources.</p>
                        {% if materials and materials|length > 0 %}
                            <p class="text-success">{{ materials|length }} materials available for download</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Debug Info (Remove in production) -->
{% if current_user.is_admin %}
<div class="container-fluid mt-4">
    <div class="card bg-light">
        <div class="card-header">
            <h6 class="mb-0">ðŸ”§ Debug Info (Admin Only)</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <strong>Course ID:</strong> {{ course.id }}<br>
                    <strong>Total Videos:</strong> {{ videos|length if videos else 0 }}<br>
                    <strong>Total Materials:</strong> {{ materials|length if materials else 0 }}
                </div>
                <div class="col-md-6">
                    {% if videos and videos|length > 0 %}
                        <strong>Video Sources:</strong>
                        <ul class="small">
                            {% for video in videos %}
                                <li>{{ video.title }}: 
                                    {% if video.video_url %}
                                        <span class="text-success">Cloudinary</span>
                                    {% else %}
                                        <span class="text-warning">Local</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.video-container {
    position: relative;
    background: #000;
}

.list-group-item.active {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

.lesson-status .fa-check {
    color: #198754;
}

.lesson-status .fa-play {
    color: #0d6efd;
}

.progress-circle {
    width: 100px;
    height: 100px;
    margin: 0 auto;
}

.video-item.completed .lesson-status .fa-play {
    display: none;
}

.video-item.completed .lesson-status .fa-check {
    display: inline;
}

.video-item.current {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

/* Video loading indicator */
.video-container::before {
    content: "Loading video...";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 16px;
    z-index: 1;
    display: none;
}

.video-container.loading::before {
    display: block;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('courseVideo');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const videoItems = document.querySelectorAll('.video-item');
    const currentVideoTitle = document.getElementById('currentVideoTitle');
    const currentVideoDescription = document.getElementById('currentVideoDescription');
    const videoCounter = document.getElementById('videoCounter');
    const videoContainer = document.querySelector('.video-container');
    
    let currentVideoIndex = 0;
    const totalVideos = {{ videos|length if videos else 0 }};
    
    // Only initialize video functionality if videos exist
    if (totalVideos > 0 && video) {
        console.log(`Initializing video player with ${totalVideos} videos`);
        
        // Initialize first video as current
        if (videoItems.length > 0) {
            videoItems[0].classList.add('current');
        }
        
        // Video loading states
        video.addEventListener('loadstart', function() {
            videoContainer.classList.add('loading');
            console.log('Video loading started');
        });
        
        video.addEventListener('loadeddata', function() {
            videoContainer.classList.remove('loading');
            console.log('Video loaded successfully');
        });
        
        video.addEventListener('error', function(e) {
            videoContainer.classList.remove('loading');
            console.error('Video error:', e);
            console.error('Video source:', video.currentSrc);
            
            // Show error message
            const errorMsg = document.createElement('div');
            errorMsg.className = 'alert alert-danger mt-3';
            errorMsg.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Video Error:</strong> Unable to load video. 
                <a href="${video.currentSrc}" target="_blank">Try direct link</a>
            `;
            video.parentNode.appendChild(errorMsg);
        });
        
        // Play/Pause functionality
        playPauseBtn.addEventListener('click', function() {
            if (video.paused) {
                video.play().catch(e => {
                    console.error('Play error:', e);
                    alert('Unable to play video. Please check your internet connection.');
                });
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                video.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        });
        
        // Fullscreen functionality
        fullscreenBtn.addEventListener('click', function() {
            if (video.requestFullscreen) {
                video.requestFullscreen();
            } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
            } else if (video.msRequestFullscreen) {
                video.msRequestFullscreen();
            }
        });
        
        // Video ended event
        video.addEventListener('ended', function() {
            markVideoAsCompleted(currentVideoIndex);
            if (currentVideoIndex < totalVideos - 1) {
                setTimeout(() => {
                    nextVideo();
                }, 1000);
            }
        });
        
        // Video play/pause events
        video.addEventListener('play', function() {
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        });
        
        video.addEventListener('pause', function() {
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        });
        
        // Navigation buttons
        prevBtn.addEventListener('click', prevVideo);
        nextBtn.addEventListener('click', nextVideo);
        
        // Curriculum item clicks
        videoItems.forEach((item, index) => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                loadVideo(index);
            });
        });
        
        function loadVideo(index) {
            if (index < 0 || index >= totalVideos) return;
            
            console.log(`Loading video ${index + 1}/${totalVideos}`);
            currentVideoIndex = index;
            const videoItem = videoItems[index];
            const newVideoSrc = videoItem.dataset.videoSrc;
            
            // Show loading state
            videoContainer.classList.add('loading');
            
            // Update video source
            video.src = newVideoSrc;
            video.load();
            
            console.log('Video source:', newVideoSrc);
            
            // Update UI
            currentVideoTitle.textContent = videoItem.dataset.videoTitle;
            currentVideoDescription.textContent = videoItem.dataset.videoDescription;
            videoCounter.textContent = `${index + 1} of ${totalVideos}`;
            
            // Update curriculum highlighting
            videoItems.forEach(item => item.classList.remove('current'));
            videoItem.classList.add('current');
            
            // Update navigation buttons
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === totalVideos - 1;
            
            if (index === totalVideos - 1) {
                nextBtn.innerHTML = 'Complete Course<i class="fas fa-check ms-2"></i>';
            } else {
                nextBtn.innerHTML = 'Next<i class="fas fa-chevron-right ms-2"></i>';
            }
        }
        
        function nextVideo() {
            if (currentVideoIndex < totalVideos - 1) {
                loadVideo(currentVideoIndex + 1);
            }
        }
        
        function prevVideo() {
            if (currentVideoIndex > 0) {
                loadVideo(currentVideoIndex - 1);
            }
        }
        
        function markVideoAsCompleted(index) {
            const videoItem = videoItems[index];
            if (videoItem) {
                videoItem.classList.add('completed');
                const statusIcon = videoItem.querySelector('.lesson-status i');
                if (statusIcon) {
                    statusIcon.className = 'fas fa-check';
                }
            }
            updateProgress();
        }
        
        function updateProgress() {
            const completedVideos = document.querySelectorAll('.video-item.completed').length;
            const percentage = Math.round((completedVideos / totalVideos) * 100);
            
            const progressBar = document.getElementById('overallProgress');
            const progressPercentage = document.getElementById('progressPercentage');
            const completedLessons = document.getElementById('completedLessons');
            
            if (progressBar) progressBar.style.width = percentage + '%';
            if (progressPercentage) progressPercentage.textContent = percentage + '%';
            if (completedLessons) completedLessons.textContent = completedVideos;
        }
        
        // Save progress to localStorage (basic implementation)
        function saveProgress() {
            const courseId = {{ course.id }};
            const completedVideos = Array.from(document.querySelectorAll('.video-item.completed'))
                .map(item => parseInt(item.dataset.videoIndex));
            localStorage.setItem(`course_${courseId}_progress`, JSON.stringify({
                completedVideos: completedVideos,
                currentVideo: currentVideoIndex
            }));
        }
        
        // Load progress from localStorage
        function loadProgress() {
            const courseId = {{ course.id }};
            const saved = localStorage.getItem(`course_${courseId}_progress`);
            if (saved) {
                try {
                    const progress = JSON.parse(saved);
                    if (progress.completedVideos && Array.isArray(progress.completedVideos)) {
                        progress.completedVideos.forEach(index => {
                            if (index >= 0 && index < totalVideos) {
                                markVideoAsCompleted(index);
                            }
                        });
                    }
                    if (progress.currentVideo && progress.currentVideo >= 0 && progress.currentVideo < totalVideos) {
                        loadVideo(progress.currentVideo);
                    }
                } catch (e) {
                    console.log('Error loading progress:', e);
                }
            }
        }
        
        // Auto-save progress
        video.addEventListener('timeupdate', function() {
            if (video.currentTime > 10) { // Mark as started after 10 seconds
                saveProgress();
            }
        });
        
        // Load saved progress on page load
        loadProgress();
        
        // Debug info
        console.log('Video player initialized successfully');
        console.log('First video source:', video.src);
    } else {
        console.log('No videos found or video element missing');
    }
});
</script>
{% endblock %}
