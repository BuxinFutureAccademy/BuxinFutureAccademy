<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Message Results - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .result-card {
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .message-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #25d366;
            white-space: pre-line;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .whatsapp-link {
            text-decoration: none;
            color: #25d366;
        }
        .whatsapp-link:hover {
            color: #128c7e;
        }
        .copy-btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .progress-custom {
            height: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-chart-line me-2"></i>Bulk Message Campaign Results</h2>
                    <div>
                        <a href="{{ url_for('bulk_message') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>Send New Campaign
                        </a>
                        <a href="{{ url_for('admin_users') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Back to Users
                        </a>
                    </div>
                </div>
            </div>
        </div>

        {% if whatsapp_results %}
        <!-- Summary Stats -->
        <div class="stats-card">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="d-flex flex-column">
                        <span class="h3 mb-0">{{ whatsapp_results|length }}</span>
                        <small>Total Recipients</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex flex-column">
                        <span class="h3 mb-0 text-success">{{ success_count or 0 }}</span>
                        <small>Successfully Sent</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex flex-column">
                        <span class="h3 mb-0 text-warning">{{ (total_attempted or 0) - (success_count or 0) }}</span>
                        <small>Failed</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex flex-column">
                        <span class="h3 mb-0 text-info">{{ "%.1f"|format(success_rate or 0) }}%</span>
                        <small>Success Rate</small>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            {% if total_attempted and total_attempted > 0 %}
            <div class="mt-3">
                <div class="progress progress-custom">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ (success_count / total_attempted * 100) if total_attempted > 0 else 0 }}%"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small>Campaign Progress</small>
                    <small>{{ success_count }}/{{ total_attempted }} sent successfully</small>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- WhatsApp Results Table -->
        <div class="card result-card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fab fa-whatsapp text-success me-2"></i>WhatsApp Message Results
                </h5>
                <div>
                    <button class="btn btn-sm btn-success" onclick="copyAllResults()">
                        <i class="fas fa-copy me-1"></i>Copy Results
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="downloadResults()">
                        <i class="fas fa-download me-1"></i>Download CSV
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="resultsTable">
                        <thead class="table-light">
                            <tr>
                                <th>User</th>
                                <th>Phone Number</th>
                                <th>Status</th>
                                <th>Message ID</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in whatsapp_results %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ result.user.first_name }} {{ result.user.last_name }}</strong>
                                        <br><small class="text-muted">{{ result.user.email }}</small>
                                    </div>
                                </td>
                                <td>
                                    {% if result.phone and result.phone != 'N/A' %}
                                        <code>{{ result.phone }}</code>
                                    {% else %}
                                        <span class="text-muted">No WhatsApp</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if result.status == 'sent' %}
                                        <span class="badge bg-success status-badge">
                                            <i class="fas fa-check me-1"></i>Sent
                                        </span>
                                    {% elif result.status.startswith('skipped') %}
                                        <span class="badge bg-secondary status-badge">
                                            <i class="fas fa-skip-forward me-1"></i>Skipped
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger status-badge">
                                            <i class="fas fa-times me-1"></i>Failed
                                        </span>
                                        <br><small class="text-muted">{{ result.status.replace('failed: ', '')[:50] }}...</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if result.get('sid') and result.sid != 'Unknown' %}
                                        <code class="small">{{ result.sid[:20] }}...</code>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if whatsapp_links %}
                                        {% for link in whatsapp_links %}
                                            {% if link.user.id == result.user.id %}
                                                <a href="{{ link.link }}" target="_blank" class="btn btn-sm btn-outline-success whatsapp-link me-1">
                                                    <i class="fab fa-whatsapp"></i>
                                                </a>
                                                <button class="btn btn-sm btn-outline-primary copy-btn" 
                                                        onclick="copyToClipboard('{{ link.link }}', this)">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Message Preview -->
        {% if message %}
        <div class="card result-card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-eye me-2"></i>Message Preview
                </h5>
            </div>
            <div class="card-body">
                <div class="message-preview">{{ message }}</div>
            </div>
        </div>
        {% endif %}

        <!-- WhatsApp Links for Manual Sending -->
        {% if whatsapp_links %}
        <div class="card result-card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-link me-2"></i>Manual WhatsApp Links
                    <small class="text-muted">(Backup option for failed messages)</small>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for link in whatsapp_links %}
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ link.user.first_name }} {{ link.user.last_name }}</strong>
                                    <br><small class="text-muted">{{ link.phone }}</small>
                                </div>
                                <div>
                                    <a href="{{ link.link }}" target="_blank" class="btn btn-sm btn-success">
                                        <i class="fab fa-whatsapp me-1"></i>Open
                                    </a>
                                    <button class="btn btn-sm btn-outline-primary ms-1" 
                                            onclick="copyToClipboard('{{ link.link }}', this)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- No Results -->
        <div class="card result-card">
            <div class="card-body text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No WhatsApp results to display</h5>
                <p class="text-muted">No WhatsApp messages were processed in this campaign.</p>
                <a href="{{ url_for('bulk_message') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Start New Campaign
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Email Results (if any) -->
        {% if email_count and email_count > 0 %}
        <div class="card result-card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-envelope me-2"></i>Email Results
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Successfully sent <strong>{{ email_count }}</strong> emails!
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(function() {
                // Change button text temporarily
                const originalHtml = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-success');
                
                setTimeout(function() {
                    button.innerHTML = originalHtml;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-primary');
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                alert('Could not copy to clipboard');
            });
        }

        function copyAllResults() {
            const table = document.getElementById('resultsTable');
            const rows = table.querySelectorAll('tbody tr');
            let csvContent = "Name,Phone,Status,Message ID\n";
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const name = cells[0].querySelector('strong').textContent.trim();
                const phone = cells[1].querySelector('code') ? cells[1].querySelector('code').textContent : 'No WhatsApp';
                const status = cells[2].querySelector('.badge').textContent.trim();
                const messageId = cells[3].querySelector('code') ? cells[3].querySelector('code').textContent : '-';
                
                csvContent += `"${name}","${phone}","${status}","${messageId}"\n`;
            });
            
            navigator.clipboard.writeText(csvContent).then(function() {
                alert('All results copied to clipboard!');
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                alert('Could not copy to clipboard');
            });
        }

        function downloadResults() {
            const table = document.getElementById('resultsTable');
            const rows = table.querySelectorAll('tbody tr');
            let csvContent = "Name,Email,Phone,Status,Message ID,Error Details\n";
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const name = cells[0].querySelector('strong').textContent.trim();
                const email = cells[0].querySelector('small').textContent.trim();
                const phone = cells[1].querySelector('code') ? cells[1].querySelector('code').textContent : 'No WhatsApp';
                const status = cells[2].querySelector('.badge').textContent.trim();
                const errorDetails = cells[2].querySelector('small') ? cells[2].querySelector('small').textContent.trim() : '';
                const messageId = cells[3].querySelector('code') ? cells[3].querySelector('code').textContent : '-';
                
                csvContent += `"${name}","${email}","${phone}","${status}","${messageId}","${errorDetails}"\n`;
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "whatsapp_campaign_results.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Filter results by status
        function filterResults(status) {
            const rows = document.querySelectorAll('#resultsTable tbody tr');
            rows.forEach(row => {
                const statusCell = row.querySelector('td:nth-child(3)');
                if (status === 'all') {
                    row.style.display = '';
                } else {
                    const hasStatus = statusCell.textContent.toLowerCase().includes(status.toLowerCase());
                    row.style.display = hasStatus ? '' : 'none';
                }
            });
        }

        // Auto-hide flash messages after 5 seconds
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);

        // Add filter buttons
        document.addEventListener('DOMContentLoaded', function() {
            const cardHeader = document.querySelector('.card-header');
            if (cardHeader && document.querySelectorAll('#resultsTable tbody tr').length > 0) {
                const filterDiv = document.createElement('div');
                filterDiv.className = 'mt-2';
                filterDiv.innerHTML = `
                    <small class="text-muted me-2">Filter:</small>
                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="filterResults('all')">All</button>
                    <button class="btn btn-sm btn-outline-success me-1" onclick="filterResults('sent')">Sent</button>
                    <button class="btn btn-sm btn-outline-danger me-1" onclick="filterResults('failed')">Failed</button>
                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="filterResults('skipped')">Skipped</button>
                `;
                cardHeader.appendChild(filterDiv);
            }
        });
    </script>
</body>
</html>
