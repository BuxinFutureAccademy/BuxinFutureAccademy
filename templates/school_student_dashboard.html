{% extends "base.html" %}

{% block navbar %}
<!-- Simplified Navigation for School Student Dashboard - Logo + Sign Out Only -->
<nav class="navbar navbar-expand-lg navbar-light">
    <div class="container">
        <a class="navbar-brand" href="javascript:void(0);" onclick="window.location.reload(); return false;">
            <img src="https://res.cloudinary.com/dfizb64hx/image/upload/v1753480189/Untvvvvitled-1_i2iduk.png" alt="Logo" width="30" height="30" class="d-inline-block align-text-top me-2">
            BuXin Academy
        </a>
        
        <div class="ms-auto">
            <a class="nav-link d-inline-block" href="{{ url_for('schools.school_student_logout') }}">
                <i class="fas fa-sign-out-alt me-1"></i>Sign Out
            </a>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --robotics-primary: #00d4ff;
        --robotics-secondary: #ff6b35;
        --robotics-accent: #39ff14;
        --robotics-dark: #0a0a1a;
        --robotics-darker: #050510;
        --robotics-gradient: linear-gradient(135deg, #00d4ff 0%, #0099cc 50%, #006699 100%);
        --robotics-neon: linear-gradient(135deg, #39ff14 0%, #00d4ff 100%);
        --surface: rgba(255, 255, 255, 0.05);
        --surface-solid: rgba(5, 5, 16, 0.9);
        --background: var(--robotics-darker);
        --on-surface: #ffffff;
        --text-secondary: rgba(255, 255, 255, 0.7);
        --border: rgba(0, 212, 255, 0.3);
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 20px 25px -5px rgba(0, 212, 255, 0.2), 0 10px 10px -5px rgba(0, 212, 255, 0.1);
        --shadow-neon: 0 0 30px rgba(0, 212, 255, 0.3);
        --radius: 16px;
        --radius-sm: 8px;
        --font-tech: 'Orbitron', sans-serif;
        --font-body: 'Rajdhani', sans-serif;
    }

    body {
        background: var(--background);
        background-image: 
            radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 30%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
            linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
        background-size: 100% 100%, 100% 100%, 50px 50px, 50px 50px;
        font-family: var(--font-body);
        color: var(--on-surface);
        min-height: 100vh;
    }

    /* Modern Header */
    .classroom-header {
        background: var(--surface-solid);
        border-bottom: 2px solid var(--border);
        padding: 2rem 0;
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
    }

    .classroom-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--robotics-gradient);
        opacity: 0.1;
    }

    .welcome-section {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        position: relative;
        z-index: 2;
    }

    .welcome-content h1 {
        font-family: var(--font-tech);
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--on-surface);
        margin: 0;
        background: var(--robotics-neon);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .welcome-subtitle {
        color: var(--text-secondary);
        margin: 0.5rem 0 0 0;
        font-size: 1.1rem;
        font-family: var(--font-body);
    }

    .quick-stats {
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }

    .stat-card {
        background: var(--surface-solid);
        padding: 1rem 1.5rem;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        text-align: center;
        min-width: 100px;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-neon);
        border-color: var(--robotics-primary);
    }

    .stat-number {
        font-family: var(--font-tech);
        font-size: 1.5rem;
        font-weight: 700;
        background: var(--robotics-neon);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Main Layout */
    .classroom-container {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    /* Quick Actions Sidebar */
    .quick-actions {
        background: var(--surface-solid);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        height: fit-content;
        position: sticky;
        top: 2rem;
        backdrop-filter: blur(10px);
    }

    .section-title {
        font-family: var(--font-tech);
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--robotics-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--on-surface);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        font-family: var(--font-body);
    }

    .action-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: var(--robotics-gradient);
        transition: left 0.3s ease;
        z-index: 0;
    }

    .action-btn:hover::before {
        left: 0;
    }

    .action-btn:hover {
        color: var(--robotics-dark);
        border-color: var(--robotics-primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-neon);
    }

    .action-btn i,
    .action-btn span {
        position: relative;
        z-index: 1;
    }

    .action-btn .badge {
        margin-left: auto;
        position: relative;
        z-index: 1;
    }

    /* Main Content Area */
    .main-content {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    /* Live Classes Section */
    .live-class-section {
        background: var(--surface-solid);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        backdrop-filter: blur(10px);
        margin-bottom: 2rem;
    }

    .live-class-card {
        background: var(--surface);
        border: 2px solid var(--robotics-accent);
        border-radius: var(--radius-sm);
        padding: 1.5rem;
    }

    .live-class-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .live-class-title {
        font-family: var(--font-tech);
        font-size: 1.5rem;
        color: var(--robotics-accent);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    .live-class-title .pulse-dot {
        color: #ff0000;
        animation: pulse 2s infinite;
    }

    /* Learning Materials Feed */
    .materials-feed {
        background: var(--surface-solid);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .feed-header {
        background: var(--robotics-gradient);
        color: white;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .feed-controls {
        display: flex;
        gap: 0.5rem;
    }

    .feed-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: var(--font-body);
    }

    .feed-btn:hover,
    .feed-btn.active {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
    }

    .materials-container {
        max-height: 600px;
        overflow-y: auto;
        padding: 0;
    }

    .material-item {
        border-bottom: 1px solid var(--border);
        padding: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        background: var(--surface);
    }

    .material-item:hover {
        background: rgba(0, 212, 255, 0.05);
    }

    .material-item:last-child {
        border-bottom: none;
    }

    .material-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .class-badge {
        background: var(--robotics-gradient);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: var(--font-tech);
    }

    .material-time {
        color: var(--text-secondary);
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .material-content {
        color: var(--on-surface);
        line-height: 1.6;
        margin-bottom: 1rem;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.2s;
        position: relative;
        word-break: break-word;
    }

    .material-content.expanded {
        background: rgba(57, 255, 20, 0.1);
        border: 1px solid var(--robotics-accent);
    }

    .material-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .material-action {
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: var(--font-body);
    }

    .material-action:hover {
        background: var(--robotics-gradient);
        color: white;
        border-color: var(--robotics-primary);
    }

    /* Tools Sidebar */
    .tools-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .tool-widget {
        background: var(--surface-solid);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        position: sticky;
        top: 2rem;
        backdrop-filter: blur(10px);
    }

    /* Clock Widget */
    .clock-widget {
        text-align: center;
        background: var(--robotics-gradient);
        color: white;
    }

    .current-time {
        font-family: var(--font-tech);
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .current-date {
        font-size: 1rem;
        opacity: 0.9;
    }

    /* Calendar Widget */
    .calendar-widget {
        background: var(--success-gradient);
        color: white;
    }

    .calendar-header {
        text-align: center;
        margin-bottom: 1rem;
        font-weight: 600;
        font-family: var(--font-tech);
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.25rem;
        font-size: 0.875rem;
    }

    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .calendar-day:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .calendar-day.today {
        background: rgba(255, 255, 255, 0.3);
        font-weight: 700;
    }

    /* Notes Widget */
    .notes-widget textarea {
        width: 100%;
        min-height: 120px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 1rem;
        font-family: var(--font-body);
        resize: vertical;
        transition: all 0.3s ease;
        background: var(--surface);
        color: var(--on-surface);
    }

    .notes-widget textarea:focus {
        outline: none;
        border-color: var(--robotics-primary);
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    /* Progress Widget */
    .progress-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .progress-label {
        font-size: 0.875rem;
        color: var(--on-surface);
        font-weight: 500;
    }

    .progress-bar-container {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }

    .progress-fill {
        height: 100%;
        background: var(--robotics-neon);
        border-radius: 4px;
        transition: width 0.6s ease;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        opacity: 0.5;
        background: var(--robotics-neon);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Custom Scrollbar */
    .materials-container::-webkit-scrollbar {
        width: 8px;
    }

    .materials-container::-webkit-scrollbar-track {
        background: var(--surface);
    }

    .materials-container::-webkit-scrollbar-thumb {
        background: var(--robotics-gradient);
        border-radius: 4px;
    }

    .materials-container::-webkit-scrollbar-thumb:hover {
        background: var(--robotics-primary);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .classroom-container {
            grid-template-columns: 1fr 2fr;
        }
        
        .tools-sidebar {
            grid-column: 1 / -1;
            grid-row: 3;
            flex-direction: row;
            overflow-x: auto;
        }
        
        .tool-widget {
            min-width: 280px;
            position: static;
        }
    }

    @media (max-width: 768px) {
        .classroom-container {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .welcome-section {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .quick-stats {
            width: 100%;
            justify-content: space-between;
        }
        
        .tools-sidebar {
            flex-direction: column;
        }
        
        .tool-widget {
            min-width: auto;
        }
        
        .quick-actions {
            position: static;
        }
        
        .materials-container {
            max-height: 400px;
        }
    }
</style>

<!-- Modern Classroom Header -->
<div class="classroom-header">
    <div class="container">
        <div class="welcome-section">
            <div class="welcome-content">
                <h1>SCHOOL CLASSROOM</h1>
                <p class="welcome-subtitle">Welcome back, {{ student.student_name }}! Ready to build the future?</p>
            </div>
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-number">{{ enrolled_classes|length }}</div>
                    <div class="stat-label">Active Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ projects_count if projects_count else 0 }}</div>
                    <div class="stat-label">My Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ materials|length if materials else 0 }}</div>
                    <div class="stat-label">Materials</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Profile Section -->
    <div class="profile-section" style="background: var(--surface-solid); border-radius: var(--radius); padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border);">
        <div class="row align-items-center">
            <div class="col-md-3 text-center">
                <div class="profile-picture-container" style="position: relative; display: inline-block;">
                    {% if student.student_image_url %}
                        <img src="{{ student.student_image_url }}" alt="Profile Picture" 
                             style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid var(--robotics-primary);">
                    {% else %}
                        <div style="width: 150px; height: 150px; border-radius: 50%; background: var(--robotics-gradient); display: flex; align-items: center; justify-content: center; border: 3px solid var(--robotics-primary); margin: 0 auto;">
                            <i class="fas fa-user" style="font-size: 4rem; color: white;"></i>
                        </div>
                    {% endif %}
                    <div class="profile-actions mt-3">
                        <form method="POST" action="{{ url_for('admin.upload_school_student_profile_picture') }}" enctype="multipart/form-data" style="display: inline;">
                            <input type="file" name="profile_picture" accept="image/*" id="profile-upload-school" style="display: none;" onchange="this.form.submit()">
                            <label for="profile-upload-school" class="btn btn-sm" style="background: var(--robotics-primary); color: var(--robotics-dark); border: none; margin-right: 0.5rem; cursor: pointer;">
                                <i class="fas fa-upload me-1"></i>{{ 'Change' if student.student_image_url else 'Upload' }}
                            </label>
                        </form>
                        {% if student.student_image_url %}
                        <form method="POST" action="{{ url_for('admin.delete_school_student_profile_picture') }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete your profile picture?');">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <h2 style="color: var(--robotics-primary); font-family: var(--font-tech); margin-bottom: 1rem;">
                    <i class="fas fa-user-circle me-2"></i>Profile Information
                </h2>
                <div class="profile-info">
                    <div class="info-row mb-2">
                        <strong style="color: var(--text-secondary);">School Student Name:</strong>
                        <span style="color: var(--on-surface); margin-left: 1rem;">{{ student.student_name }}</span>
                    </div>
                    <div class="info-row mb-2">
                        <strong style="color: var(--text-secondary);">School Student System ID:</strong>
                        <code style="background: rgba(0, 212, 255, 0.2); color: var(--robotics-accent); padding: 0.25rem 0.5rem; border-radius: 4px; margin-left: 1rem;">{{ student.student_system_id }}</code>
                    </div>
                    <div class="info-row mb-2">
                        <strong style="color: var(--text-secondary);">Class/Subject:</strong>
                        <span style="color: var(--on-surface); margin-left: 1rem;">
                            {% if enrolled_classes %}
                                {% for cls in enrolled_classes %}
                                    {{ cls.name }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </div>
                    <div class="info-row mb-2">
                        <strong style="color: var(--text-secondary);">Associated Entity:</strong>
                        <span style="color: var(--on-surface); margin-left: 1rem;">School Student</span>
                    </div>
                    {% if id_card %}
                    <div class="info-row mb-2 mt-3">
                        <a href="{{ url_for('admin.view_id_card', id_card_id=id_card.id) }}" 
                           class="btn btn-sm" 
                           style="background: var(--robotics-primary); color: var(--robotics-dark); border: none; width: 100%;">
                            <i class="fas fa-print me-2"></i>Print ID Card
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Classroom Layout -->
    <div class="classroom-container">
        <!-- Quick Actions Sidebar -->
        <div class="quick-actions">
            <h3 class="section-title">
                <i class="fas fa-bolt"></i>
                Quick Actions
            </h3>
            
            <a href="https://www.tinkercad.com/joinclass/SCT4QKX8A" class="action-btn" target="_blank">
                <i class="fas fa-robot"></i>
                <span>Tinkercad</span>
                <span class="badge bg-primary">Join</span>
            </a>

            <a href="{{ url_for('store.store') }}" class="action-btn">
                <i class="fas fa-store"></i>
                <span>Browse Classes</span>
            </a>
            
            <a href="{{ url_for('student_projects.student_projects') }}" class="action-btn">
                <i class="fas fa-eye"></i>
                <span>View All Projects</span>
            </a>
            
            <a href="{{ url_for('student_projects.create_project') }}" class="action-btn">
                <i class="fas fa-plus-circle"></i>
                <span>Create Project</span>
            </a>
            
            <a href="{{ url_for('student_projects.my_projects') }}" class="action-btn">
                <i class="fas fa-user"></i>
                <span>My Projects</span>
            </a>
            
            <a href="{{ url_for('integrations.ai_assistant') }}" class="action-btn">
                <i class="fas fa-brain"></i>
                <span>AI Assistant</span>
            </a>
            
            <a href="{{ url_for('projects.robotics_projects') }}" class="action-btn">
                <i class="fas fa-robot"></i>
                <span>Submit Project</span>
            </a>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Live Classes Section - Only visible when current time matches student's class time -->
            {% if active_live_class %}
            <div class="live-class-section">
                <h2 class="section-title" style="color: var(--robotics-accent);">
                    <i class="fas fa-video"></i>
                    LIVE CLASSES
                </h2>
                <div class="live-class-card">
                    <div class="live-class-header">
                        <div>
                            <div class="live-class-title">
                                <i class="fas fa-circle pulse-dot"></i>
                                LIVE CLASS IN SESSION
                            </div>
                            <small class="text-muted">Join the live class meeting now</small>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-calendar-day me-1"></i>{{ active_live_class.class_time.day }}
                                    <i class="fas fa-clock me-1 ms-2"></i>{{ active_live_class.class_time.get_display_time(student_timezone) }}
                                    <i class="fas fa-book me-1 ms-2"></i>{{ active_live_class.class.name if active_live_class.class else 'Class' }}
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3" style="border-radius: var(--radius-sm); overflow: hidden; background: #000; min-height: 500px;">
                        <iframe 
                            allow="camera; microphone; fullscreen; display-capture; autoplay" 
                            src="https://meet.jit.si/SportingDimensionsEmphasizeGenerally#config.prejoinPageEnabled=false&config.requireDisplayName=false&config.startWithAudioMuted=false&config.startWithVideoMuted=false&interfaceConfig.SHOW_JITSI_WATERMARK=false&interfaceConfig.SHOW_WATERMARK_FOR_GUESTS=false&userInfo.displayName={{ session.get('student_name', 'Student')|urlencode }}" 
                            style="height: 600px; width: 100%; border: 0px; display: block;">
                        </iframe>
                    </div>
                    
                    <div class="mt-3">
                        <div class="alert" style="background: rgba(57, 255, 20, 0.1); border: 1px solid var(--robotics-accent); color: var(--on-surface);">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Instructions:</strong> Click "Allow" when prompted to enable your camera and microphone for the live class.
                            <br><small class="d-block mt-1"><i class="fas fa-globe me-1"></i>Time shown in your local country timezone</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Learning Materials Feed -->
            <div class="materials-feed">
                <div class="feed-header">
                    <div>
                        <h3 style="margin: 0; font-weight: 600;">
                            <i class="fas fa-stream me-2"></i>
                            LEARNING MATERIALS
                        </h3>
                        <small style="opacity: 0.9;">Latest updates from your classes</small>
                    </div>
                    <div class="feed-controls">
                        <button class="feed-btn active" onclick="filterMaterials('all')">All</button>
                        <button class="feed-btn" onclick="filterMaterials('today')">Today</button>
                        <button class="feed-btn" onclick="filterMaterials('week')">This Week</button>
                    </div>
                </div>
                
                <div class="materials-container" id="materials-container">
                    {% if materials %}
                        {% for material in materials %}
                            <div class="material-item" data-date="{{ material.created_at.strftime('%Y-%m-%d') }}">
                                <div class="material-header">
                                    <span class="class-badge">{{ material.class_name() }}</span>
                                    <div class="material-time">
                                        <i class="fas fa-clock"></i>
                                        {{ material.created_at.strftime('%b %d, %Y') }}
                                    </div>
                                </div>
                                
                                <div class="material-content" id="material-{{ material.id }}">
                                    <!-- YouTube Video -->
                                    {% if material.material_type == 'youtube' and material.youtube_url %}
                                        {% set youtube_id = material.youtube_url.split('v=')[1].split('&')[0] if 'v=' in material.youtube_url else (material.youtube_url.split('youtu.be/')[1].split('?')[0] if 'youtu.be/' in material.youtube_url else material.youtube_url.split('/')[-1]) %}
                                        <div class="youtube-embed-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin-bottom: 1rem; border-radius: var(--radius-sm); overflow: hidden; background: #000;">
                                            <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                                                    src="https://www.youtube.com/embed/{{ youtube_id }}?rel=0" 
                                                    frameborder="0" 
                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                                    allowfullscreen></iframe>
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Uploaded Image -->
                                    {% if material.material_type == 'image' and material.file_url %}
                                        <div class="material-image-container" style="margin-bottom: 1rem;">
                                            <img src="{{ material.file_url }}" 
                                                 alt="{{ material.file_name or 'Learning Material Image' }}" 
                                                 style="max-width: 100%; height: auto; border-radius: var(--radius-sm); cursor: pointer;"
                                                 onclick="openImageModal('{{ material.file_url }}', '{{ material.file_name or 'Image' }}')">
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Uploaded Video -->
                                    {% if material.material_type == 'video' and material.file_url %}
                                        <div class="material-video-container" style="margin-bottom: 1rem;">
                                            <video controls style="width: 100%; max-height: 500px; border-radius: var(--radius-sm);">
                                                <source src="{{ material.file_url }}" type="video/{{ material.file_type or 'mp4' }}">
                                                Your browser does not support the video tag.
                                            </video>
                                        </div>
                                    {% endif %}
                                    
                                    <!-- PDF Viewer -->
                                    {% if material.material_type == 'pdf' and material.file_url %}
                                        <div class="material-pdf-container" style="margin-bottom: 1rem; border: 1px solid var(--border); border-radius: var(--radius-sm); overflow: hidden;">
                                            <iframe src="{{ material.file_url }}#toolbar=1" 
                                                    style="width: 100%; height: 600px; border: none;"
                                                    type="application/pdf">
                                            </iframe>
                                            <div style="padding: 0.5rem; background: var(--surface); text-align: center;">
                                                <a href="{{ material.file_url }}" target="_blank" style="color: var(--robotics-primary); text-decoration: none;">
                                                    <i class="fas fa-download me-2"></i>Download PDF: {{ material.file_name or 'Document' }}
                                                </a>
                                            </div>
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Text Content -->
                                    <div onclick="toggleExpand({{ material.id }})" style="cursor: pointer;">
                                        {{ material.content|urlize(target='_blank')|safe }}
                                    </div>
                                </div>
                                
                                <div class="material-actions">
                                    <button class="material-action" onclick="bookmarkMaterial({{ material.id }})">
                                        <i class="fas fa-bookmark"></i>
                                        Bookmark
                                    </button>
                                    <button class="material-action" onclick="shareMaterial({{ material.id }})">
                                        <i class="fas fa-share"></i>
                                        Share
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-book-open"></i>
                            <h4>No learning materials yet</h4>
                            <p>Materials shared by your instructors will appear here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tools & Widgets Sidebar -->
        <div class="tools-sidebar">
            <!-- Live Clock Widget -->
            <div class="tool-widget clock-widget">
                <div class="current-time" id="current-time">--:--</div>
                <div class="current-date" id="current-date">--</div>
            </div>

            <!-- Quick Calendar -->
            <div class="tool-widget calendar-widget">
                <h4 class="section-title" style="color: white; margin-bottom: 1rem;">
                    <i class="fas fa-calendar-alt"></i>
                    Calendar
                </h4>
                <div class="calendar-header" id="calendar-month">-- 2024</div>
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
            </div>

            <!-- Quick Notes -->
            <div class="tool-widget notes-widget">
                <h4 class="section-title">
                    <i class="fas fa-sticky-note"></i>
                    Quick Notes
                </h4>
                <textarea placeholder="Jot down your thoughts..." id="quick-notes"></textarea>
                <button class="btn btn-sm mt-2" style="background: var(--robotics-gradient); color: white; border: none; border-radius: 20px; padding: 0.5rem 1rem;" onclick="saveNotes()">
                    <i class="fas fa-save me-1"></i>Save
                </button>
            </div>

            <!-- Learning Progress -->
            {% if enrolled_classes %}
            <div class="tool-widget">
                <h4 class="section-title">
                    <i class="fas fa-chart-line"></i>
                    Progress
                </h4>
                
                {% for cls in enrolled_classes %}
                <div class="progress-item">
                    <span class="progress-label">{{ cls.name }}</span>
                    <div class="progress-bar-container">
                        <div class="progress-fill" style="width: {{ monthly_stats[cls.id].percentage if monthly_stats.get(cls.id) else 0 }}%;"></div>
                    </div>
                    <small class="text-muted">{{ monthly_stats[cls.id].percentage if monthly_stats.get(cls.id) else 0 }}%</small>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Initialize the modern classroom
document.addEventListener('DOMContentLoaded', function() {
    updateClock();
    generateCalendar();
    loadSavedNotes();
    processYouTubeLinksInContent();
    
    setInterval(updateClock, 1000);
});

// Process YouTube links in material content (for backward compatibility)
function processYouTubeLinksInContent() {
    const materialContents = document.querySelectorAll('.material-content');
    materialContents.forEach(function(contentDiv) {
        // Skip if already has YouTube embed
        if (contentDiv.querySelector('.youtube-embed-container')) {
            return;
        }
        
        const text = contentDiv.innerHTML;
        // Match YouTube URLs
        const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/g;
        let match;
        let hasYouTube = false;
        
        while ((match = youtubeRegex.exec(text)) !== null) {
            hasYouTube = true;
            const videoId = match[1];
            const youtubeUrl = match[0];
            
            // Create embed container
            const embedContainer = document.createElement('div');
            embedContainer.className = 'youtube-embed-container';
            embedContainer.style.cssText = 'position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin-bottom: 1rem; border-radius: var(--radius-sm); overflow: hidden; background: #000;';
            
            const iframe = document.createElement('iframe');
            iframe.src = `https://www.youtube.com/embed/${videoId}?rel=0`;
            iframe.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%;';
            iframe.frameBorder = '0';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
            iframe.allowFullscreen = true;
            
            embedContainer.appendChild(iframe);
            
            // Replace the YouTube link in content with embed
            contentDiv.innerHTML = contentDiv.innerHTML.replace(youtubeUrl, '');
            contentDiv.insertBefore(embedContainer, contentDiv.firstChild);
        }
    });
}

// Real-time clock
function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit'
    });
    const dateString = now.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    document.getElementById('current-time').textContent = timeString;
    document.getElementById('current-date').textContent = dateString;
}

// Generate calendar
function generateCalendar() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const today = now.getDate();
    
    const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    document.getElementById('calendar-month').textContent = `${monthNames[month]} ${year}`;
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = '';

    // Day headers
    const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
    dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day';
        header.textContent = day;
        header.style.fontWeight = '600';
        header.style.opacity = '0.7';
        calendarGrid.appendChild(header);
    });

    // Fill empty days before the first day of the month
    for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-day';
        emptyCell.style.visibility = 'hidden';
        calendarGrid.appendChild(emptyCell);
    }

    // Fill days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        if (day === today) {
            dayCell.classList.add('today');
        }
        dayCell.textContent = day;
        calendarGrid.appendChild(dayCell);
    }
}

// Filter materials by time frame
function filterMaterials(timeFrame) {
    const allMaterials = document.querySelectorAll('.material-item');
    const buttons = document.querySelectorAll('.feed-btn');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    allMaterials.forEach(material => {
        material.style.display = 'block';
        
        const materialDate = new Date(material.getAttribute('data-date'));
        const today = new Date();
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(today.getDate() - 7);
        
        if (timeFrame === 'today' && materialDate.toDateString() !== today.toDateString()) {
            material.style.display = 'none';
        } else if (timeFrame === 'week' && materialDate < oneWeekAgo) {
            material.style.display = 'none';
        }
    });
}

// Toggle material expansion
function toggleExpand(materialId) {
    const content = document.getElementById('material-' + materialId);
    content.classList.toggle('expanded');
}

// Save notes to local storage
function saveNotes() {
    const notesContent = document.getElementById('quick-notes').value;
    localStorage.setItem('quickNotes', notesContent);
    alert('Notes saved!');
}

// Load saved notes from local storage
function loadSavedNotes() {
    const savedNotes = localStorage.getItem('quickNotes');
    if (savedNotes) {
        document.getElementById('quick-notes').value = savedNotes;
    }
}

// Bookmark material: copy content to clipboard
function bookmarkMaterial(materialId) {
    const content = document.getElementById('material-' + materialId).innerText;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(content).then(function() {
            alert('Material content copied to clipboard!');
        }, function() {
            alert('Failed to copy content.');
        });
    } else {
        alert('Clipboard not supported.');
    }
}

// Share material: use Web Share API or fallback to copy
function shareMaterial(materialId) {
    const materialElement = document.getElementById('material-' + materialId);
    const content = materialElement.innerText;
    const materialUrl = window.location.href + '#material-' + materialId;
    
    if (navigator.share) {
        navigator.share({
            title: 'Learning Material',
            text: content,
            url: materialUrl
        }).catch(() => {
            // User cancelled or not supported
        });
    } else if (navigator.clipboard) {
        navigator.clipboard.writeText(materialUrl).then(function() {
            alert('Material link copied! You can now share it.');
        });
    } else {
        // Fallback: show share dialog
        const shareText = `Check out this learning material:\n\n${content}\n\n${materialUrl}`;
        prompt('Copy this link to share:', materialUrl);
    }
}

// Open image in modal for full-size viewing
function openImageModal(imageUrl, imageTitle) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('imageModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'imageModal';
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content" style="background: var(--surface-solid); border: 1px solid var(--border);">
                    <div class="modal-header" style="border-bottom: 1px solid var(--border);">
                        <h5 class="modal-title" style="color: var(--robotics-primary);" id="imageModalTitle"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                    </div>
                    <div class="modal-body text-center" style="padding: 0;">
                        <img id="modalImage" src="" alt="" style="max-width: 100%; height: auto; border-radius: 0;">
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('modalImage').alt = imageTitle;
    document.getElementById('imageModalTitle').textContent = imageTitle;
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}
</script>
{% endblock %}
