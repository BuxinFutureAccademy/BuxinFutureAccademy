{% extends "base.html" %}

{% block title %}Create New Product - Admin Panel{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-plus-circle me-2 text-success"></i>Create New Product</h2>
                    <p class="text-muted mb-0">Add a new product to your store catalog</p>
                </div>
                <a href="{{ url_for('admin_products') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Products
                </a>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                            <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' or category == 'danger' else 'check-circle' if category == 'success' else 'info-circle' }} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Main Form Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Product Information
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" onsubmit="return validateForm()" novalidate>
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-8">
                                <!-- Basic Information -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-tag me-2"></i>Basic Information
                                    </h6>
                                    
                                    <!-- Product Name -->
                                    <div class="mb-3">
                                        <label for="name" class="form-label fw-semibold">
                                            Product Name <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control form-control-lg" id="name" name="name" 
                                               placeholder="Enter product name..." required>
                                        <div class="invalid-feedback">Please provide a product name.</div>
                                    </div>
                                    
                                    <!-- Short Description -->
                                    <div class="mb-3">
                                        <label for="short_description" class="form-label fw-semibold">
                                            Short Description
                                        </label>
                                        <input type="text" class="form-control" id="short_description" name="short_description" 
                                               placeholder="Brief product summary (appears in listings)..." maxlength="200">
                                        <div class="form-text">Maximum 200 characters</div>
                                    </div>
                                    
                                    <!-- Full Description -->
                                    <div class="mb-3">
                                        <label for="description" class="form-label fw-semibold">
                                            Full Description <span class="text-danger">*</span>
                                        </label>
                                        <textarea class="form-control" id="description" name="description" rows="4" 
                                                  placeholder="Detailed product description..." required></textarea>
                                        <div class="invalid-feedback">Please provide a detailed description.</div>
                                    </div>
                                </div>

                                <!-- Pricing & Inventory -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-dollar-sign me-2"></i>Pricing & Inventory
                                    </h6>
                                    
                                    <div class="row">
                                        <!-- Price -->
                                        <div class="col-md-6 mb-3">
                                            <label for="price" class="form-label fw-semibold">
                                                Price <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="price" name="price" 
                                                       step="0.01" min="0" placeholder="0.00" required>
                                                <div class="invalid-feedback">Please provide a valid price.</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Stock Quantity -->
                                        <div class="col-md-6 mb-3">
                                            <label for="stock_quantity" class="form-label fw-semibold">
                                                Stock Quantity
                                            </label>
                                            <input type="number" class="form-control" id="stock_quantity" name="stock_quantity" 
                                                   min="0" value="0" placeholder="Available quantity">
                                            <div class="form-text" id="stock-help">Set to 0 for digital products</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Product Details -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-cogs me-2"></i>Product Details
                                    </h6>
                                    
                                    <div class="row">
                                        <!-- Brand -->
                                        <div class="col-md-6 mb-3">
                                            <label for="brand" class="form-label fw-semibold">Brand</label>
                                            <input type="text" class="form-control" id="brand" name="brand" 
                                                   placeholder="Product brand or manufacturer">
                                        </div>
                                        
                                        <!-- SKU -->
                                        <div class="col-md-6 mb-3">
                                            <label for="sku" class="form-label fw-semibold">
                                                SKU <small class="text-muted">(Stock Keeping Unit)</small>
                                            </label>
                                            <input type="text" class="form-control" id="sku" name="sku" 
                                                   placeholder="Auto-generated from name">
                                            <div class="form-text">Leave blank to auto-generate</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Digital Product Files Section -->
                                <div class="mb-4" id="digital-files-section" style="display: none;">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-download me-2"></i>Digital Product Files
                                    </h6>
                                    
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="digital_files" class="form-label fw-semibold">
                                                    Upload Digital Files
                                                </label>
                                                <input type="file" class="form-control" id="digital_files" name="digital_files" 
                                                       multiple accept=".pdf,.zip,.rar,.7z,.doc,.docx,.txt,.mp4,.mp3,.jpg,.png">
                                                <div class="form-text">
                                                    Upload files customers will receive after purchase. Max 100MB per file.
                                                    <br>Supported: PDF, ZIP, RAR, 7Z, DOC, DOCX, TXT, MP4, MP3, JPG, PNG
                                                </div>
                                            </div>
                                            
                                            <div id="file-list" class="mt-3"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="col-md-4">
                                <!-- Product Image -->
                                <div class="card bg-light mb-4">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-image me-2"></i>Product Image
                                        </h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <div id="image-preview" class="mb-3">
                                            <div class="border border-dashed border-secondary rounded p-4">
                                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                                                <p class="text-muted mb-0">Image Preview</p>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="image_url" class="form-label fw-semibold">Image URL</label>
                                            <input type="url" class="form-control" id="image_url" name="image_url" 
                                                   placeholder="https://example.com/image.jpg">
                                            <div class="form-text">Enter a direct link to product image</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Classification -->
                                <div class="card bg-light mb-4">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-folder me-2"></i>Classification
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Product Type -->
                                        <div class="mb-3">
                                            <label for="product_type" class="form-label fw-semibold">
                                                Product Type <span class="text-danger">*</span>
                                            </label>
                                            <select class="form-select" id="product_type" name="product_type" required>
                                                <option value="">Choose type...</option>
                                                <option value="Physical">üè∑Ô∏è Physical Product</option>
                                                <option value="Digital">üíæ Digital Product</option>
                                            </select>
                                            <div class="invalid-feedback">Please select a product type.</div>
                                        </div>
                                        
                                        <!-- Category -->
                                        <div class="mb-3">
                                            <label for="category" class="form-label fw-semibold">
                                                Category <span class="text-danger">*</span>
                                            </label>
                                            <select class="form-select" id="category" name="category" required>
                                                <option value="">Choose category...</option>
                                                <option value="Electronics">üì± Electronics</option>
                                                <option value="Books">üìö Books & eBooks</option>
                                                <option value="Accessories">üéß Accessories</option>
                                                <option value="Software">üíª Software</option>
                                                <option value="Courses">üéì Projects</option>
                                                <option value="Tools">üîß Tools & Equipment</option>
                                                <option value="Fashion">üõ¥ Electric Scooter</option>
                                                <option value="Health">üè• Health & Wellness</option>
                                                <option value="Sports">üì± Smart Devices</option>
                                                <option value="Home">‚úàÔ∏è Drones & Airplanes</option>
                                                <option value="Other">üì¶ Other</option>
                                            </select>
                                            <div class="invalid-feedback">Please select a category.</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Product Options -->
                                <div class="card bg-light">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-toggle-on me-2"></i>Product Options
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            <input type="checkbox" class="form-check-input" id="is_active" name="is_active" checked>
                                            <label class="form-check-label fw-semibold" for="is_active">
                                                <i class="fas fa-eye text-success me-1"></i>Active Product
                                            </label>
                                            <div class="form-text">Product will be visible to customers</div>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="featured" name="featured">
                                            <label class="form-check-label fw-semibold" for="featured">
                                                <i class="fas fa-star text-warning me-1"></i>Featured Product
                                            </label>
                                            <div class="form-text">Highlight in featured sections</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                    <div class="text-muted">
                                        <small><i class="fas fa-info-circle me-1"></i>Fields marked with * are required</small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <a href="{{ url_for('admin_products') }}" class="btn btn-secondary">
                                            <i class="fas fa-times me-2"></i>Cancel
                                        </a>
                                        <button type="button" class="btn btn-outline-primary" onclick="resetForm()">
                                            <i class="fas fa-undo me-2"></i>Reset
                                        </button>
                                        <div class="btn-group">
                                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                                <span class="spinner-border spinner-border-sm d-none me-2" id="submitSpinner"></span>
                                                <i class="fas fa-save me-2" id="submitIcon"></i>Create Product
                                            </button>
                                            <button type="button" class="btn btn-success btn-lg dropdown-toggle dropdown-toggle-split" 
                                                    data-bs-toggle="dropdown" aria-expanded="false">
                                                <span class="visually-hidden">Toggle Dropdown</span>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <button type="submit" class="dropdown-item" name="action" value="save_and_new">
                                                        <i class="fas fa-plus me-2"></i>Save & Create Another
                                                    </button>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Form validation and enhancements
function validateForm() {
    const form = document.querySelector('form');
    const requiredFields = ['name', 'description', 'price', 'product_type', 'category'];
    let isValid = true;

    // Reset previous validation states
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    form.querySelectorAll('.is-valid').forEach(el => el.classList.remove('is-valid'));

    // Validate required fields
    requiredFields.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        const value = field.value.trim();

        if (!value) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.add('is-valid');
        }
    });

    // Validate price
    const priceField = document.getElementById('price');
    const price = parseFloat(priceField.value);
    if (isNaN(price) || price < 0) {
        priceField.classList.add('is-invalid');
        showAlert('Please enter a valid price (0 or greater).', 'danger');
        isValid = false;
    }

    // Validate stock quantity
    const stockField = document.getElementById('stock_quantity');
    const stock = parseInt(stockField.value);
    if (isNaN(stock) || stock < 0) {
        stockField.classList.add('is-invalid');
        showAlert('Please enter a valid stock quantity (0 or greater).', 'danger');
        isValid = false;
    }

    // Validate image URL if provided
    const imageUrlField = document.getElementById('image_url');
    const imageUrl = imageUrlField.value.trim();
    if (imageUrl) {
        try {
            new URL(imageUrl);
        } catch {
            imageUrlField.classList.add('is-invalid');
            showAlert('Please enter a valid image URL.', 'danger');
            isValid = false;
        }
    }

    if (!isValid) {
        // Scroll to first invalid field
        const firstInvalidField = form.querySelector('.is-invalid');
        if (firstInvalidField) {
            firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalidField.focus();
        }
        return false;
    }

    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const submitIcon = document.getElementById('submitIcon');
    const submitSpinner = document.getElementById('submitSpinner');

    submitBtn.disabled = true;
    submitIcon.classList.add('d-none');
    submitSpinner.classList.remove('d-none');
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating Product...';

    return true;
}

// Auto-generate SKU from product name
document.getElementById('name').addEventListener('input', function() {
    const name = this.value.trim();
    const skuField = document.getElementById('sku');
    
    if (name && !skuField.value) {
        const sku = name.toUpperCase()
            .replace(/[^A-Z0-9\s]/g, '')
            .replace(/\s+/g, '-')
            .substring(0, 8);
        
        if (sku) {
            skuField.value = sku + '-001';
        }
    }
});

// Handle product type changes
document.getElementById('product_type').addEventListener('change', function() {
    const stockField = document.getElementById('stock_quantity');
    const stockHelp = document.getElementById('stock-help');
    const digitalSection = document.getElementById('digital-files-section');
    
    if (this.value === 'Digital') {
        stockField.value = '0';
        stockField.disabled = true;
        stockHelp.textContent = 'Digital products have unlimited stock';
        stockField.parentElement.classList.add('text-muted');
        digitalSection.style.display = 'block';
    } else {
        stockField.disabled = false;
        stockHelp.textContent = 'Enter available quantity';
        stockField.parentElement.classList.remove('text-muted');
        digitalSection.style.display = 'none';
    }
});

// Handle digital file selection
document.getElementById('digital_files').addEventListener('change', function() {
    const fileList = document.getElementById('file-list');
    const files = this.files;
    
    if (files.length === 0) {
        fileList.innerHTML = '';
        return;
    }
    
    let html = '<h6>Selected Files:</h6><ul class="list-group">';
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const size = (file.size / (1024 * 1024)).toFixed(2);
        const icon = getFileIcon(file.name);
        
        html += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <i class="${icon} me-2"></i>
                    <strong>${file.name}</strong>
                    <br><small class="text-muted">${size} MB</small>
                </div>
                ${size > 100 ? '<span class="badge bg-danger">Too Large</span>' : '<span class="badge bg-success">Ready</span>'}
            </li>
        `;
    }
    
    html += '</ul>';
    fileList.innerHTML = html;
});
